<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Grappling Reference</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<style>
:root {
  --bg: #0a0c10;
  --surface: #0f1218;
  --surface2: #13161e;
  --border: #1e2535;
  --text: #dde1ed;
  --text-dim: #8890a8;
  --text-muted: #505870;
  --accent: #e8ff47;
  --accent2: #ff6b35;
  --accent3: #a78bfa;
  --blue: #47c8ff;
  --green: #34d399;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { background: var(--bg); color: var(--text); font-family: 'DM Mono', monospace; min-height: 100vh; }

/* â”€â”€ HEADER â”€â”€ */
header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 14px 20px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 40; }
.logo { font-family: 'Bebas Neue', sans-serif; font-size: 28px; letter-spacing: 3px; color: var(--accent); }
.stats { display: flex; gap: 20px; align-items: center; }
.stat { text-align: right; }
.stat-num { font-family: 'Bebas Neue', sans-serif; font-size: 22px; color: var(--accent); }
.stat-label { font-size: 9px; letter-spacing: 1.5px; color: var(--text-muted); text-transform: uppercase; }
.progress-bar-wrap { position: absolute; bottom: 0; left: 0; right: 0; height: 2px; background: var(--border); }
.progress-bar { height: 2px; background: var(--accent); transition: width 0.4s; width: 0%; }

/* â”€â”€ VIEW TABS â”€â”€ */
.view-tabs { display: flex; border-bottom: 1px solid var(--border); background: var(--surface); padding: 0 20px; overflow-x: auto; }
.view-tab { font-family: 'DM Mono', monospace; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; padding: 12px 16px; border: none; border-bottom: 2px solid transparent; background: transparent; color: var(--text-muted); cursor: pointer; transition: all 0.15s; white-space: nowrap; }
.view-tab:hover { color: var(--text); }
.view-tab.active { color: var(--accent); border-bottom-color: var(--accent); }

/* â”€â”€ SEARCH + FILTER BAR (shared) â”€â”€ */
.toolbar { display: flex; align-items: center; gap: 10px; padding: 10px 16px; background: var(--surface); border-bottom: 1px solid var(--border); flex-wrap: wrap; }
.search-wrap { flex: 1; min-width: 180px; display: flex; align-items: center; gap: 8px; background: var(--bg); border: 1px solid var(--border); border-radius: 3px; padding: 6px 10px; }
.search-wrap input { background: transparent; border: none; color: var(--text); font-family: 'DM Mono', monospace; font-size: 12px; width: 100%; outline: none; }
.search-wrap input::placeholder { color: var(--text-muted); }
.filter-tabs { display: flex; gap: 4px; }
.tab { font-family: 'DM Mono', monospace; font-size: 10px; letter-spacing: 1px; text-transform: uppercase; padding: 5px 10px; border: 1px solid var(--border); background: transparent; color: var(--text-muted); cursor: pointer; border-radius: 2px; transition: all 0.15s; }
.tab:hover { color: var(--text); border-color: var(--text-muted); }
.tab.active { color: var(--bg); background: var(--accent); border-color: var(--accent); }
.toolbar-btn { font-family: 'DM Mono', monospace; font-size: 10px; letter-spacing: 1px; text-transform: uppercase; padding: 5px 10px; border: 1px solid var(--border); background: transparent; color: var(--text-muted); cursor: pointer; border-radius: 2px; transition: all 0.15s; }
.toolbar-btn:hover { color: var(--accent); border-color: var(--accent); }

/* â”€â”€ REFERENCE VIEW â”€â”€ */
#referenceView { }
.sections { padding: 12px 16px; }
.section { border: 1px solid var(--border); border-radius: 4px; margin-bottom: 8px; background: var(--surface); overflow: hidden; }
.section-header { display: flex; align-items: center; gap: 10px; padding: 12px 16px; cursor: pointer; user-select: none; transition: background 0.15s; }
.section-header:hover { background: var(--surface2); }
.section-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
.section-title { font-family: 'Bebas Neue', sans-serif; font-size: 16px; letter-spacing: 1.5px; flex: 1; }
.view-in-map-btn { font-size: 13px; opacity: 0.35; cursor: pointer; padding: 2px 4px; transition: opacity 0.15s; }
.view-in-map-btn:hover { opacity: 1; }
.section-chevron { color: var(--text-muted); font-size: 12px; transition: transform 0.2s; }
.section.collapsed .section-chevron { transform: rotate(-90deg); }
.section-body { display: block; }
.section.collapsed .section-body { display: none; }
.tree { list-style: none; padding: 0 0 8px; }
.tree-item { }
.node { display: flex; align-items: flex-start; gap: 6px; padding: 4px 16px 4px 8px; transition: background 0.1s; min-height: 32px; }
.node:hover { background: rgba(255,255,255,0.03); }
.node-toggle { width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-size: 11px; color: var(--text-muted); cursor: pointer; flex-shrink: 0; margin-top: 2px; border-radius: 2px; transition: all 0.15s; font-family: 'DM Mono', monospace; }
.node-toggle:hover { background: var(--border); color: var(--text); }
.node-toggle.leaf { cursor: default; color: var(--border); }
.node-toggle.leaf:hover { background: transparent; color: var(--border); }
.node-content { display: flex; align-items: center; gap: 8px; flex: 1; flex-wrap: wrap; }
.node-label { font-size: 12px; color: var(--text-dim); cursor: default; line-height: 1.4; }
.node-label.has-video { color: var(--text); }
.node-actions { display: flex; align-items: center; gap: 5px; flex-wrap: wrap; }
.btn-video { font-family: 'DM Mono', monospace; font-size: 9px; letter-spacing: 0.5px; padding: 3px 7px; border: 1px solid var(--accent2); color: var(--accent2); background: transparent; cursor: pointer; border-radius: 2px; transition: all 0.15s; }
.btn-video:hover { background: var(--accent2); color: #000; }
.btn-live { border-color: var(--green) !important; color: var(--green) !important; }
.btn-live:hover { background: var(--green) !important; color: #000 !important; }
.btn-note { font-family: 'DM Mono', monospace; font-size: 12px; padding: 2px 6px; border: 1px solid var(--border); color: var(--text-muted); background: transparent; cursor: pointer; border-radius: 2px; transition: all 0.15s; }
.btn-note:hover { border-color: var(--accent3); color: var(--accent3); }
.btn-note.has-note { border-color: var(--accent3); color: var(--accent3); }
.progress-pill { font-family: 'DM Mono', monospace; font-size: 9px; letter-spacing: 0.5px; padding: 3px 7px; border: 1px solid var(--border); color: var(--text-muted); background: transparent; cursor: pointer; border-radius: 2px; transition: all 0.15s; text-transform: uppercase; white-space: nowrap; }
.progress-pill:hover { border-color: var(--text-muted); color: var(--text); }
.progress-pill.drilling { border-color: var(--blue); color: var(--blue); }
.progress-pill.learned { border-color: var(--accent); color: var(--accent); background: rgba(232,255,71,0.05); }
.children { list-style: none; }
.tree-item.collapsed > .children { display: none; }
.inline-player { }

/* â”€â”€ 2D MAP VIEW â”€â”€ */
#customMapView { position: relative; background: #080a0e; overflow: hidden; }
#cmSvg { display: block; }
.map-toolbar { display: flex; align-items: center; gap: 8px; padding: 8px 16px; background: var(--surface); border-bottom: 1px solid var(--border); }

/* â”€â”€ 3D GRAPH VIEW â”€â”€ */
#graph3dView { position: relative; background: #020408; overflow: hidden; }
#g3dCanvas { display: block; }
.g3d-toolbar { display: flex; align-items: center; gap: 8px; padding: 8px 16px; background: rgba(2,4,8,0.9); border-bottom: 1px solid #0a0f1a; }

/* â”€â”€ MINDOMO VIEW â”€â”€ */
#mapView { }

/* â”€â”€ SHARED MAP/GRAPH CONTROLS â”€â”€ */
.mctrl { width: 30px; height: 30px; background: var(--surface2); border: 1px solid var(--border); color: var(--text-muted); font-size: 16px; cursor: pointer; border-radius: 3px; transition: all 0.15s; font-family: 'DM Mono', monospace; display: flex; align-items: center; justify-content: center; }
.mctrl:hover { border-color: var(--accent); color: var(--accent); }
.mctrl-label { font-size: 10px; letter-spacing: 1px; text-transform: uppercase; padding: 0 10px; height: 30px; width: auto; }

/* â”€â”€ NODE POPUP (used in 2D and 3D) â”€â”€ */
.node-popup {
  position: absolute; bottom: 60px; left: 50%; transform: translateX(-50%);
  background: var(--surface); border: 1px solid var(--border); border-radius: 6px;
  padding: 14px 16px; z-index: 200; width: 300px; max-width: 90vw;
  box-shadow: 0 8px 40px rgba(0,0,0,0.7); display: none;
}
.popup-header { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
.popup-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
.popup-title { font-family: 'Bebas Neue', sans-serif; font-size: 17px; letter-spacing: 1px; flex: 1; }
.popup-close { background: transparent; border: 1px solid var(--border); color: var(--text-muted); cursor: pointer; width: 22px; height: 22px; border-radius: 2px; font-size: 12px; display: flex; align-items: center; justify-content: center; }
.popup-section { font-size: 9px; letter-spacing: 1.5px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 10px; }
.popup-actions { display: flex; gap: 6px; flex-wrap: wrap; align-items: center; margin-bottom: 8px; }
.popup-video { display: none; margin-top: 8px; }
.popup-video-inner { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 4px; border: 1px solid var(--border); }
.popup-video-inner iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }
.popup-note-area { margin-top: 8px; display: none; }
.popup-note-area textarea { width: 100%; background: var(--bg); border: 1px solid var(--border); color: var(--text); font-family: 'DM Mono', monospace; font-size: 11px; padding: 6px 8px; border-radius: 3px; resize: vertical; min-height: 60px; outline: none; }
.popup-note-area textarea:focus { border-color: var(--accent3); }
.popup-note-save { font-family: 'DM Mono', monospace; font-size: 9px; letter-spacing: 1px; text-transform: uppercase; padding: 4px 10px; border: 1px solid var(--accent3); color: var(--accent3); background: transparent; cursor: pointer; border-radius: 2px; margin-top: 4px; }

/* â”€â”€ NOTE PANEL â”€â”€ */
.overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 50; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
.overlay.active { opacity: 1; pointer-events: all; }
.note-panel { position: fixed; bottom: 0; left: 0; right: 0; background: var(--surface); border-top: 1px solid var(--border); padding: 20px; z-index: 60; transform: translateY(100%); transition: transform 0.25s; max-height: 70vh; display: flex; flex-direction: column; gap: 12px; }
.note-panel.open { transform: translateY(0); }
.note-panel-title { font-family: 'Bebas Neue', sans-serif; font-size: 16px; letter-spacing: 1px; color: var(--accent3); }
.note-panel textarea { flex: 1; min-height: 120px; background: var(--bg); border: 1px solid var(--border); color: var(--text); font-family: 'DM Mono', monospace; font-size: 12px; padding: 10px; border-radius: 3px; resize: none; outline: none; }
.note-panel textarea:focus { border-color: var(--accent3); }
.note-panel-actions { display: flex; gap: 8px; }
.btn-save-note { font-family: 'DM Mono', monospace; font-size: 10px; letter-spacing: 1px; text-transform: uppercase; padding: 8px 16px; border: none; background: var(--accent3); color: #000; cursor: pointer; border-radius: 2px; }
.btn-clear-note { font-family: 'DM Mono', monospace; font-size: 10px; letter-spacing: 1px; text-transform: uppercase; padding: 8px 16px; border: 1px solid var(--border); background: transparent; color: var(--text-muted); cursor: pointer; border-radius: 2px; }

/* â”€â”€ 2D MAP NODES â”€â”€ */
.cm-node-foreign { overflow: visible; }
.cm-node-box { border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.15s; white-space: nowrap; text-align: center; padding: 0 6px; user-select: none; }
.cm-node-box:hover { filter: brightness(1.3); }
</style>
</head>
<body>

<header>
  <div class="logo">Grappling</div>
  <div class="stats">
    <div class="stat"><div class="stat-num" id="learnedCount">0</div><div class="stat-label">Learned</div></div>
    <div class="stat"><div class="stat-num" id="totalCount">0</div><div class="stat-label">Total</div></div>
  </div>
  <div class="progress-bar-wrap"><div class="progress-bar" id="progressBar"></div></div>
</header>

<div class="view-tabs">
  <button class="view-tab active" data-view="reference">ðŸ“‹ Reference</button>
  <button class="view-tab" data-view="custommap">âœ¦ 2D Map</button>
  <button class="view-tab" data-view="graph3d">â¬¡ 3D Graph</button>
</div>

<!-- â•â• REFERENCE VIEW â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="referenceView">
  <div class="toolbar">
    <div class="search-wrap">
      <span style="color:var(--text-muted);font-size:12px;">âŒ•</span>
      <input type="text" id="refSearch" placeholder="Search techniques...">
    </div>
    <div class="filter-tabs">
      <button class="tab active" data-filter="all">All</button>
      <button class="tab" data-filter="drilling">Drilling</button>
      <button class="tab" data-filter="learned">Learned</button>
      <button class="tab" data-filter="video">Video</button>
    </div>
    <button class="toolbar-btn" id="refCollapseAll">Collapse All</button>
  </div>
  <div class="sections" id="sections"></div>
</div>



<!-- â•â• 2D CUSTOM MAP â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="customMapView" style="display:none; flex-direction:column;">
  <div class="toolbar">
    <div class="search-wrap">
      <span style="color:var(--text-muted);font-size:12px;">âŒ•</span>
      <input type="text" id="cmSearch" placeholder="Search techniques...">
    </div>
    <div class="filter-tabs">
      <button class="tab active cm-filter" data-filter="all">All</button>
      <button class="tab cm-filter" data-filter="drilling">Drilling</button>
      <button class="tab cm-filter" data-filter="learned">Learned</button>
    </div>
    <button class="toolbar-btn" id="cmCollapseAll">Collapse All</button>
    <button class="toolbar-btn" id="cmExpandAll">Expand All</button>
  </div>
  <div style="position:relative; flex:1; overflow:hidden; background:#080a0e; min-height:calc(100vh - 200px);" id="cmCanvas" style="position:relative;flex:1;min-height:0;height:calc(100vh - 160px);">
    <svg id="cmSvg" style="position:absolute;top:0;left:0;" overflow="visible"></svg>
    <div style="position:absolute;top:8px;right:8px;display:flex;gap:5px;z-index:10;">
      <button class="mctrl" id="cmZoomIn">+</button>
      <button class="mctrl" id="cmZoomOut">&#8722;</button>
      <button class="mctrl mctrl-label" id="cmReset">RESET</button>
    </div>
    <div id="cmPopup" class="node-popup"></div>
  </div>
</div>

<!-- â•â• 3D GRAPH â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="graph3dView" style="display:none; flex-direction:column;">
  <div class="toolbar" style="background:rgba(2,4,8,0.95);">
    <div class="search-wrap" style="background:#050810;border-color:#0a0f1a;">
      <span style="color:var(--text-muted);font-size:12px;">âŒ•</span>
      <input type="text" id="g3dSearch" placeholder="Search techniques...">
    </div>
    <div class="filter-tabs">
      <button class="tab active g3d-filter" data-filter="all" style="border-color:#0a0f1a;">All</button>
      <button class="tab g3d-filter" data-filter="drilling" style="border-color:#0a0f1a;">Drilling</button>
      <button class="tab g3d-filter" data-filter="learned" style="border-color:#0a0f1a;">Learned</button>
    </div>
    <button class="toolbar-btn" id="g3dReset" style="border-color:#0a0f1a;">Reset View</button>
  </div>
  <div style="position:relative; flex:1; overflow:hidden; background:#020408; min-height:calc(100vh - 200px);" id="g3dCanvas-wrap" style="position:relative;flex:1;min-height:0;height:calc(100vh - 160px);">
    <canvas id="g3dCanvas" style="display:block;width:100%;height:100%;"></canvas>
    <div style="position:absolute;top:8px;right:8px;display:flex;gap:5px;z-index:10;">
      <button class="mctrl" id="g3dZoomIn">+</button>
      <button class="mctrl" id="g3dZoomOut">&#8722;</button>
    </div>
    <div id="g3dTooltip" style="position:absolute;display:none;background:#13161e;border:1px solid #1e2535;color:#dde1ed;font-family:'DM Mono',monospace;font-size:11px;padding:5px 9px;border-radius:3px;pointer-events:none;z-index:100;max-width:220px;"></div>
    <div id="g3dPopup" class="node-popup"></div>
    <div style="position:absolute;bottom:8px;left:12px;font-family:'DM Mono',monospace;font-size:10px;color:#1e2535;letter-spacing:1px;">DRAG TO ROTATE Â· SCROLL TO ZOOM Â· CLICK NODE FOR DETAILS</div>
  </div>
</div>

<!-- â•â• NOTE PANEL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="overlay" id="overlay"></div>
<div class="note-panel" id="notePanel">
  <div class="note-panel-title" id="notePanelTitle"></div>
  <textarea id="noteTextarea" placeholder="Add your notes here..."></textarea>
  <div class="note-panel-actions">
    <button class="btn-save-note" id="noteSaveBtn">Save Note</button>
    <button class="btn-clear-note" id="noteClearBtn">Clear</button>
    <button class="btn-clear-note" id="noteCloseBtn" style="margin-left:auto;">Close</button>
  </div>
</div>

<script>
// â”€â”€â”€ DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SECTIONS = [{"title": "Wrestling forBrazillian Jiu Jitsu", "color": "#e8ff47", "nodes": [{"t": "- Collar Tie", "c": [{"t": "Entries", "v": "https://youtu.be/Ye-Jvn023XI", "c": [{"t": "Outside tie", "v": "https://youtu.be/Ye-Jvn023XI"}, {"t": "Collar tie", "v": "https://youtu.be/Kf0wQ00FPBg"}]}, {"t": "Offence", "c": [{"t": "Brush by", "v": "https://youtu.be/oejTa6J72gE", "n": "Most effective when opponent is heavy on collar tie", "c": [{"t": "- Disengaging", "v": "https://youtu.be/oejTa6J72gE"}, {"t": "- Rear body lock", "v": "https://youtu.be/oXuG3DJBMEE"}, {"t": "- Snatch head inside single", "v": "https://youtu.be/B6jTl90lucM"}, {"t": "Snatch head outside single", "v": "https://youtu.be/WtUX-OiWYkU"}]}, {"t": "-Throw by", "v": "https://youtu.be/1wOwMfPHMDs", "c": [{"t": "Head to head", "v": "https://youtu.be/1wOwMfPHMDs"}, {"t": "Head to shoulder", "v": "https://youtu.be/m42WTwg3Feo"}, {"t": "Outside tie", "v": "https://youtu.be/ZLbj39rn6pU"}]}, {"t": "Snap downs", "v": "https://youtu.be/WZ--OY1yQXU", "c": [{"t": "Collar Tie and Inside Tie Snap Down", "v": "https://youtu.be/WZ--OY1yQXU"}, {"t": "Overtie snap", "v": "https://youtu.be/NlIBlkV5PVY"}, {"t": "Brush by snap", "v": "https://youtu.be/QE8PS6puob0"}]}, {"t": "- 2 on 1", "c": [{"t": "- Offence", "v": "https://youtu.be/r0-5x2mBL84", "c": [{"t": "- Climb to back", "v": "https://youtu.be/r0-5x2mBL84"}, {"t": "- Snatch single", "v": "https://youtu.be/cdQakEraYKE"}, {"t": "- ankle pick", "v": "https://youtu.be/6RapDAy2HQQ"}, {"t": "- front headlock", "v": "https://youtu.be/DzxwkbNuUBw"}]}, {"t": "- Defence", "c": [{"t": "Framing on head"}, {"t": "Pulling far elbow", "c": [{"t": "Underhook"}]}]}]}]}]}, {"t": "- Wrestling hand fighting positions", "c": [{"t": "- Inside Tie", "c": [{"t": "- [Inside Tie to Sweep Single]"}]}, {"t": "- Over/Under", "c": [{"t": "- Arm drag"}, {"t": "- Sweep single"}, {"t": "- Snatch single"}, {"t": "- Inside leg trip"}, {"t": "- Inside leg trip to scissor takedown"}, {"t": "- Knee tap"}]}, {"t": "- Underhook", "c": [{"t": "- Head inside double"}, {"t": "- run the pipe"}, {"t": "- foot lift"}, {"t": "- Side bodylock", "c": [{"t": "- Front side uchimata"}, {"t": "- Lift and dump"}]}, {"t": "- Rear bodylock throwby", "c": [{"t": "- Mat return"}, {"t": "- Cran ride entry", "c": [{"t": "- Back take"}, {"t": "- Knee staple"}]}, {"t": "- Lift and dump"}]}, {"t": "- [Snatch head inside Single]"}, {"t": "- Knee tap"}, {"t": "- Front headlock"}, {"t": "- Snatch head outside sngle"}, {"t": "- head inside single"}, {"t": "- head outside single"}]}, {"t": "- Outside tie", "c": [{"t": "- [Knee Pull Sweep Single]"}, {"t": "- throw by"}, {"t": "- collar tie throw by"}, {"t": "- head inside single"}, {"t": "- double leg"}, {"t": "- brush by"}, {"t": "- 2 on 1"}]}]}, {"t": "- Rear Bodylock", "c": [{"t": "- Turtle Rear Bodylock", "c": [{"t": "- Spiral ride", "c": [{"t": "- Near side hook", "c": [{"t": "- Far side roll", "c": [{"t": "- Hip pinch", "c": [{"t": "- Back take"}]}]}]}, {"t": "- Far side hook", "c": [{"t": "- Second hook", "c": [{"t": "- Back tke"}]}]}, {"t": "- Opponent rolls far side", "c": [{"t": "- Head arm choke"}]}]}, {"t": "- Seatbelt", "c": [{"t": "- Rolling backtake", "c": [{"t": "- Seated rear bodylock", "c": [{"t": "- Back take"}]}]}, {"t": "- Hooks in", "c": [{"t": "- Backtake"}]}]}, {"t": "- Body lock", "c": [{"t": "- Knee wedge hook in", "c": [{"t": "- Far side roll", "c": [{"t": "- Hip pinch", "c": [{"t": "- Backtake"}]}]}]}, {"t": "- Crab hook", "c": [{"t": "- Seated rear body lock", "c": [{"t": "- Back take"}]}]}]}]}, {"t": "- Tripod Rear Bodylock", "c": [{"t": "- Throwing hooks in", "c": [{"t": "- Weight on hands", "c": [{"t": "- Half nelson", "c": [{"t": "- Backtake"}]}, {"t": "- 2 on 1", "c": [{"t": "- Back take"}]}]}, {"t": "- Weight on feet", "c": [{"t": "- Rear naked choke"}, {"t": "- Underhooking knee", "c": [{"t": "- Suloev stretch"}]}, {"t": "- Half nelson", "c": [{"t": "- Shoulder stretch"}]}]}]}, {"t": "- Elbow in thigh takedown", "c": [{"t": "- Turtle Rear bodylock"}]}, {"t": "- Feet behind heels", "c": [{"t": "- Crab ride"}]}]}, {"t": "- Standing Rear Bodylock", "c": [{"t": "- Defence", "c": [{"t": "- Grip Breaks", "c": [{"t": "- [Grip Break 1]"}, {"t": "- [Grip Break 2]"}, {"t": "- [Grip Break 3 ]"}]}, {"t": "- Counters", "c": [{"t": "- [Uchi Mata Counter Front Headlock]"}, {"t": "- [Uchi Mata Counter Ankle Pick]"}, {"t": "- [Uchi Mata Throw Counter ]"}, {"t": "- [Chin Push Counter to Front Bodylock]"}, {"t": "- [Inside Leg Trip Counter to Front Bodylock]"}, {"t": "- [Lift and Sweep Counter to Side Bodylock]"}]}]}, {"t": "- Offence", "c": [{"t": "- [Mat return]"}, {"t": "- [Front Side Uchi Mata from Side Bodylock]"}, {"t": "- [Lower Back Crunch from Front Bodylock]"}, {"t": "- Crab Ride Entry"}]}, {"t": "- c"}]}]}, {"t": "- Head Inside Single", "c": [{"t": "- Offence", "c": [{"t": "- [Foot Lift Takedown]"}, {"t": "- Shin Whizzer", "c": [{"t": "- [Limp Arm Counter to Shin Whizzer]"}, {"t": "- [Running the Pipe Counter to Shin Whizzer]"}, {"t": "- [Head Inside Double Leg Counter to Shin Whizzer]"}, {"t": "- [Collar Tie Ankle Tap Counter to Shin Whizzer]"}]}, {"t": "- Tripod Defence", "c": [{"t": "- [Rear Body Lock counter to Tripod Defence]"}]}, {"t": "- Near Side Block", "c": [{"t": "- [Knock Over Rear Bodylock counter to Near Side Block Tripod]"}]}, {"t": "- Iranian", "c": [{"t": "- [Iranian counter to Sprawl]"}, {"t": "- [Iranian to Rear Bodylock counter to Sprawl]"}]}, {"t": "- Sprawl", "c": [{"t": "- [Shelfing the Leg counter to Sprawl]"}, {"t": "- [Shelfing leg through Grounded Shin Whizzer]"}, {"t": "- [Cut Back Single Leg counter to Sprawl]"}]}]}, {"t": "- Defence", "c": [{"t": "- Near Side Block", "c": [{"t": "- [Tripod Defence Near Side Block ]"}, {"t": "- Bail out"}]}, {"t": "- Shin Whizzer", "c": [{"t": "- [Shin Whizzer Front Headlock Counter]"}, {"t": "- [Grip Break Defence from Shin Whizzer]"}]}, {"t": "- Tripod Defence", "c": [{"t": "- [Inside Switch Tripod Defence]"}, {"t": "- Bail out"}]}, {"t": "- Iranian", "c": [{"t": "- [Near Side Block counter to Iranian]"}, {"t": "- Bail out"}]}, {"t": "- Sprawl", "c": [{"t": "- Grounded Shin Whizzer"}, {"t": "- [How to Sprawl]"}, {"t": "- [Sprawl to Belly Whizzer]"}]}]}]}, {"t": "- Head Outside Single", "c": [{"t": "- Running the pipe"}, {"t": "- Double leg", "c": [{"t": "- Hands locked"}, {"t": "- Split grip", "c": [{"t": "- complete double"}, {"t": "- Cut to rear body lock", "c": [{"t": "- tripod breakdown"}]}]}]}, {"t": "-Crackdown"}]}, {"t": "- Double Leg"}, {"t": "- Grounded 50/50"}]}, {"title": "Guard Passing", "color": "#ff6b35", "nodes": [{"t": "Outside Camping", "c": [{"t": "- J point", "v": "https://youtu.be/YxIJBbf55a0", "c": [{"t": "- Entries", "v": "https://youtu.be/8toccngMCZg", "c": [{"t": "Seated guard", "v": "https://youtu.be/5-jZLnq4Ak8", "c": [{"t": "Hip post", "v": "https://youtu.be/5-jZLnq4Ak8"}, {"t": "Collar tie", "v": "https://youtu.be/ZbmUQD0lIAs"}]}, {"t": "Supine guard", "v": "https://youtu.be/8toccngMCZg"}]}, {"t": "- Maintaing Camping Control points", "v": "https://youtu.be/YxIJBbf55a0"}, {"t": "- Passes", "v": "https://youtu.be/UZt7aEEds7w", "c": [{"t": "Toerando", "v": "https://youtu.be/UZt7aEEds7w"}, {"t": "Leg drag", "v": "https://youtu.be/OYfI4G1T4Lg"}, {"t": "North South", "v": "https://youtu.be/Vy-66UJAySQ"}, {"t": "Sprawl", "v": "https://youtu.be/UtSsoK-66Mc"}]}, {"t": "-Preventing andcountering defences", "v": "https://youtu.be/K8s4BNprDLM", "c": [{"t": "Lasso", "v": "https://youtu.be/kQ7gqbS78cI", "c": [{"t": "Transition opposite side", "v": "https://youtu.be/F4t5ba7q7Gk", "c": [{"t": "Bicep curl", "v": "https://youtu.be/F4t5ba7q7Gk"}, {"t": "Bicep ride", "v": "https://youtu.be/j1Wscyup89w"}, {"t": "C grip", "v": "https://youtu.be/U2Vy92unNgE"}, {"t": "Forearm pressure"}]}, {"t": "Back swim", "v": "https://youtu.be/kQ7gqbS78cI"}, {"t": "Stripping lasso", "v": "https://youtu.be/GdsHijqF0nE"}]}, {"t": "Deep Lasso", "v": "https://youtu.be/K8s4BNprDLM"}, {"t": "Bottom leg reguarding", "v": "https://youtu.be/QkHNNI6OBJQ", "c": [{"t": "Reverse de la riva", "v": "https://youtu.be/QkHNNI6OBJQ"}, {"t": "K Guard", "v": "https://youtu.be/4hngRqXbdd0"}]}, {"t": "Arm Frames", "v": "https://youtu.be/_i4wJYP-ufY"}, {"t": "X guard", "v": "https://youtu.be/kOeZo7YOtEg"}, {"t": "Bringing far leg under arm", "v": "https://youtu.be/cf0JTjYqLaY", "c": [{"t": "Good elbow positioning", "v": "https://youtu.be/cf0JTjYqLaY"}, {"t": "Smash pass", "v": "https://youtu.be/b030JiTk6n0"}]}, {"t": "Foot shoulder frame", "v": "https://youtu.be/bTdaK2nOD8M"}, {"t": "Far shoulder clamp", "v": "https://youtu.be/gxeob3A3OzU"}, {"t": "Elevated hips", "v": "https://youtu.be/zAcqkPKfD6k"}]}]}, {"t": "- Supine Guard Passing", "v": "https://youtu.be/AxZjQX_zAmg", "c": [{"t": "Entries", "v": "https://youtu.be/WuqJwZVi1fQ", "c": [{"t": "- J point"}, {"t": "- Bullfighter", "v": "https://youtu.be/WuqJwZVi1fQ"}]}, {"t": "Maintaing camping control points", "v": "https://youtu.be/AxZjQX_zAmg"}, {"t": "Passes", "v": "https://youtu.be/jfVGYxM8DWM", "c": [{"t": "Toreando", "v": "https://youtu.be/jfVGYxM8DWM"}, {"t": "Head in pocket", "v": "https://youtu.be/BTDNCkCDVZk"}, {"t": "Cross control", "v": "https://youtu.be/zWjF2k9YpdQ"}, {"t": "Scoop grip", "v": "https://youtu.be/fuwhG1nlgdE"}]}, {"t": "Preventing and counter defences", "c": [{"t": "Coil", "v": "https://youtu.be/_K7PVS2V5J0", "c": [{"t": "Duck under pass", "v": "https://youtu.be/_K7PVS2V5J0"}, {"t": "Clearing early coils", "v": "https://youtu.be/-Q0Az-RU2dI"}, {"t": "Back step", "v": "https://youtu.be/nDmdipl_ukQ"}]}, {"t": "Frames", "v": "https://youtu.be/ufTLXamMOok", "c": [{"t": "Shimmying body", "v": "https://youtu.be/ufTLXamMOok"}, {"t": "Cross control pass", "v": "https://youtu.be/Esi57ptb-gY"}, {"t": "Head in pocket pass", "v": "https://youtu.be/sJEs3bd-fSc"}]}, {"t": "K Guard", "v": "https://youtu.be/AwH7GoN-0YE", "c": [{"t": "Single under pass", "v": "https://youtu.be/AwH7GoN-0YE"}]}, {"t": "Knees to chest", "v": "https://youtu.be/WMT0Cz-PBo0", "c": [{"t": "scoop grip", "v": "https://youtu.be/WMT0Cz-PBo0"}, {"t": "Cross control", "v": "https://youtu.be/9xvQoSS68SE"}]}, {"t": "Inverting", "c": [{"t": "Diving crab ride"}, {"t": "Head in belly"}]}]}]}]}, {"t": "- Seated Guard Passing", "c": [{"t": "- Cross Grip", "c": [{"t": "- Collar tie", "c": [{"t": "- Overback"}, {"t": "- North south"}]}]}, {"t": "- High Tripod", "c": [{"t": "- Entries"}, {"t": "- Arm and head position"}, {"t": "- Passes", "c": [{"t": "- Shoving leg down"}, {"t": "- Hip switch"}, {"t": "- Knee cut"}, {"t": "- Stepping over leg"}]}]}, {"t": "- Bodylock", "c": [{"t": "- Bodylock positioning", "c": [{"t": "- One arm deep one shallow"}, {"t": "- Tricep pressure"}, {"t": "- Head centered"}, {"t": "- Hips to ass"}, {"t": "- Pulling in"}]}, {"t": "Entries", "c": [{"t": "Flat back"}, {"t": "Seated guard"}]}, {"t": "- Passes", "c": [{"t": "- Two butterfly hooks", "c": [{"t": "- Stepping over to mount", "c": [{"t": "- mount"}]}, {"t": "- Two legs on one shin", "c": [{"t": "- side control"}]}, {"t": "- Step over to half butterfly", "c": [{"t": "- Half butterfly"}]}]}, {"t": "- Half butterfly", "c": [{"t": "- Turn hips away", "c": [{"t": "- Back step", "c": [{"t": "- side control"}]}, {"t": "- Smash pass", "c": [{"t": "- side control"}]}]}]}, {"t": "- Half guard", "c": [{"t": "- Head post windshield wiper"}, {"t": "- Climb to underhooks", "c": [{"t": "- Half guard passing"}]}]}]}, {"t": "- Dealing with defenses", "c": [{"t": "- Slipping out to closed guard", "c": [{"t": "- Pinning feet"}]}, {"t": "High knee"}, {"t": "Omoplata", "c": [{"t": "- Gogopalata", "c": [{"t": "- Bringing head to pummeling leg side"}]}]}, {"t": "- Framing head", "c": [{"t": "- Stepping over opposite side"}]}, {"t": "- Framing knees", "c": [{"t": "- Using head to create room"}]}, {"t": "- Pushing bodylock down", "c": [{"t": "- Tight bodylock"}]}, {"t": "- Underhooking arm for", "c": [{"t": "Trap arm"}, {"t": "Shoulder crunch defence"}]}]}]}]}, {"t": "- Shin pin", "c": [{"t": "J point"}, {"t": "- Rau drag"}, {"t": "- Arm weave", "c": [{"t": "- Overback", "c": [{"t": "- North South"}]}, {"t": "- Reverse collar tie", "c": [{"t": "- North south passing"}]}]}]}, {"t": "- Reverse de la riva", "c": [{"t": "- Kiss of the dragon", "c": [{"t": "- [Crab ride]"}, {"t": "- [Wrestle up tripod rear bodylock]"}]}]}, {"t": "- De la riva", "c": [{"t": "- Baby bolo", "c": [{"t": "- [crab ride]"}, {"t": "- wrestle up tripod"}]}]}, {"t": "- Knee shield Half guard", "c": [{"t": "- [K hook Body X"}]}, {"t": "- K guard", "c": [{"t": "- [Passing foot across"}, {"t": "Crab Ride Entry]"}]}, {"t": "- Single leg X", "c": [{"t": "- Standing", "c": [{"t": "- Strip foot push knee through step leg passed to pass"}, {"t": "- Strip leg back step"}]}, {"t": "- Seated", "c": [{"t": "- Strip foot on hip hop over push pull out"}]}]}, {"t": "- X guard", "c": [{"t": "- Control foot clear other back step to pass"}, {"t": "- If wrestle up inside switch tripod"}]}, {"t": "- Outside ashi", "c": [{"t": "- Control knee line , feet off hips, knee facing inwards, shoe laces to mat", "c": [{"t": "- Smash pass"}]}, {"t": "- Knee wedge berimbolo", "c": [{"t": "- Back take"}, {"t": "- Reverse half", "c": [{"t": "- Twister hook arm underhook", "c": [{"t": "- Back take"}]}, {"t": "- Chair sit arm underhook"}]}]}]}, {"t": "- Butterfly ashi", "c": [{"t": "- Clear foot back step"}, {"t": "- Spin out if ankle being exposed", "c": [{"t": "- Escape"}, {"t": "- Crab ride"}]}]}, {"t": "- Reverse de la riva", "c": [{"t": "- Back step strip foot step back in", "c": [{"t": "- I point"}]}, {"t": "- Diving to crab x", "c": [{"t": "- Crab ride"}]}]}, {"t": "- De la riva", "c": [{"t": "- Turn knee outward", "c": [{"t": "- Push ankle force headquartes", "c": [{"t": "- Headquarters"}, {"t": "- High tripod"}]}, {"t": "- Knee to flooor"}]}, {"t": "- Diving leg drag", "c": [{"t": "- Hammer down"}]}, {"t": "- Diving crab x", "c": [{"t": "- Crab ride"}]}]}, {"t": "- K guard", "c": [{"t": "- Hips low on foot fight feet", "c": [{"t": "- North south passing"}, {"t": "- Underhook mount"}]}, {"t": "- Crab shin wedge", "c": [{"t": "- Crab ride"}]}]}, {"t": "- Knee shield half guard", "c": [{"t": "- Standard", "c": [{"t": "- Sprawling split squat"}]}, {"t": "- Z guard", "c": [{"t": "- Low head split squat"}]}]}, {"t": "- Half butterfly", "c": [{"t": "- High tripod"}, {"t": "- Bodylock"}]}, {"t": "- Butterfly guard", "c": [{"t": "- Bodylock"}, {"t": "- High tripod"}, {"t": "shoulder crunch", "c": [{"t": "- Early prevention"}, {"t": "- Shoulder crunch defence"}, {"t": "- Double unders", "c": [{"t": "- Posture up pummel underhook"}, {"t": "- Arms above head", "c": [{"t": "- Elbows back", "c": [{"t": "- Posture up pummel underhook"}, {"t": "- Foot on hip", "c": [{"t": "- Hip switch", "c": [{"t": "- Posture up pummel underhook"}]}]}]}]}]}, {"t": "- Wrestle ups"}, {"t": "Subtopic"}]}]}, {"t": "- Half Guard Passing", "c": [{"t": "- Chest to chest", "c": [{"t": "- Upper body controls", "c": [{"t": "- Crossface"}, {"t": "- Double unders"}, {"t": "- Near side underhook"}, {"t": "- Head positioning"}]}, {"t": "- Passes", "c": [{"t": "- Windshield wiper", "c": [{"t": "- Three quarter mount", "c": [{"t": "- Mount"}]}, {"t": "- Knee cut"}]}]}]}]}, {"t": "- Quarter guard", "c": [{"t": "- Side control"}, {"t": "- Dealing with defences", "c": [{"t": "- John wayne sweep", "c": [{"t": "- Knees facing same way"}]}, {"t": "- Kimura", "c": [{"t": "- Early prevention"}, {"t": "- Clearing kimura"}]}, {"t": "- Underhook wrestle up", "c": [{"t": "- overhook back step"}, {"t": "- Early prevention hip clamp"}]}]}, {"t": "- Knee shield", "c": [{"t": "- Split squat camping", "c": [{"t": "- Sprawling", "c": [{"t": "- Rau drag"}, {"t": "- Smashing knee shield", "c": [{"t": "- Shin pin"}, {"t": "- Mount"}]}]}, {"t": "- Tripoding", "c": [{"t": "- Shin pin"}]}, {"t": "- Dealing with defences", "c": [{"t": "- Reverse de la riva", "c": [{"t": "- Back step J point"}]}, {"t": "- K hook", "c": [{"t": "- Hand positioning"}, {"t": "- Elbow blocking"}]}, {"t": "- Arm drag", "c": [{"t": "- Overback"}]}, {"t": "- Underhook wrestle up", "c": [{"t": "- Clampoing hip near side underhook"}]}]}]}]}, {"t": "- Z Guard"}, {"t": "- Half butterfly", "c": [{"t": "- High Tripod", "c": [{"t": "- Arm and head position"}, {"t": "- Passes", "c": [{"t": "- Shoving leg down"}, {"t": "- Hip switch"}, {"t": "- Knee cut"}, {"t": "- Stepping over leg"}]}]}]}]}, {"t": "- Headquarters", "c": [{"t": "- Leg drag", "c": [{"t": "- Side control"}]}, {"t": "- Over/under", "c": [{"t": "- Control points", "c": [{"t": "- Head pressure into hip"}, {"t": "- Straight arms"}]}]}, {"t": "- Smash pass", "c": [{"t": "- Side control"}]}, {"t": "- J point"}, {"t": "- Throwing leg through", "c": [{"t": "- Three quarter mount", "c": [{"t": "- Mount"}]}]}, {"t": "- High tripod"}]}, {"t": "- Closed Guard", "c": [{"t": "- Closed Guard", "c": [{"t": "- Knee through centre"}, {"t": "- Standing ankle grip underhook break", "c": [{"t": "- delariva", "c": [{"t": "- knee too floor"}, {"t": "- smash pass"}]}, {"t": "- k guard", "c": [{"t": "- control leg step out"}, {"t": "- Crab ride shin block"}]}]}, {"t": "- Standing ankle grip push"}]}]}]}, {"title": "Dominant Positions", "color": "#a78bfa", "nodes": [{"t": "- Turtle", "c": [{"t": "- Offence", "c": [{"t": "- Seat belt", "c": [{"t": "- Rolling backtake", "c": [{"t": "- Chair sit", "c": [{"t": "- Seated crab", "c": [{"t": "- Back take"}]}]}, {"t": "- Seated crab", "c": [{"t": "- Back take"}]}]}, {"t": "- Knee wedge", "c": [{"t": "- Peel oppponents ankle", "c": [{"t": "- Single hook"}]}]}]}, {"t": "- Spiral ride", "c": [{"t": "- Near side tip over", "c": [{"t": "- Reverse d\u00e2\u0080\u0099arce"}, {"t": "- Back tale"}]}, {"t": "- Far side", "c": [{"t": "- Head an arn"}, {"t": "- Reverse d\u00e2\u0080\u0099arce"}]}, {"t": "- Near side hook", "c": [{"t": "- Near side tip over"}, {"t": "- Far side rolling backtake"}]}, {"t": "- Far side hook", "c": [{"t": "- Half nelson", "c": [{"t": "- Second hook"}]}]}]}, {"t": "- Crab hook", "c": [{"t": "- Far side crab smash"}, {"t": "- Near side tip over", "c": [{"t": "- Lat hip grip"}, {"t": "- Rear body lock", "c": [{"t": "- Near side tip over"}]}]}]}, {"t": "- Single hook"}]}, {"t": "- Defence", "c": [{"t": "- Keep them outside of legs"}, {"t": "- Blocking space for hooks"}]}, {"t": "- Counters", "c": [{"t": "- Cartwheel"}, {"t": "- Inside switch"}, {"t": "- Fatman roll"}, {"t": "- Granby"}]}]}, {"t": "- Front Headlock", "c": [{"t": "- Chin Strap", "c": [{"t": "- Head in hole", "c": [{"t": "- Offence", "c": [{"t": "- Rear Bodylock"}, {"t": "- Single leg Rear Bodylock"}, {"t": "- Whip by"}]}, {"t": "- Defence"}]}, {"t": "- High elbow guillotine", "c": [{"t": "- Offence", "c": [{"t": "- High elbow guillotine"}]}, {"t": "- Defence", "c": [{"t": "- Arm over high elbow"}, {"t": "- Stripping leg"}]}]}, {"t": "- High wrist guillotine", "c": [{"t": "- Offence", "c": [{"t": "- High wrist guillotine"}]}, {"t": "- Defence", "c": [{"t": "- Strip grip turn head"}]}]}, {"t": "- Anaconda", "c": [{"t": "- Offence", "c": [{"t": "- Anaconda"}]}, {"t": "- Defence", "c": [{"t": "- leg and arm post"}]}]}, {"t": "- Boltcutter", "c": [{"t": "- Defence", "c": [{"t": "- Push arm off head"}]}]}, {"t": "- D\u00e2\u0080\u0099arce", "c": [{"t": "- Offence", "c": [{"t": "- Bolt cutter"}, {"t": "- Turtle"}]}, {"t": "- Defence", "c": [{"t": "- Push arm off", "c": [{"t": "- Lay to back"}]}, {"t": "extend arm"}]}]}, {"t": "- Japanese Necktie", "c": [{"t": "- Offence", "c": [{"t": "- Bolt cutter"}]}, {"t": "- Defence", "c": [{"t": "- Free leg"}, {"t": "- Hide foot"}, {"t": "- Clear bolt cutter"}]}]}]}, {"t": "- Hands Locked", "c": [{"t": "- High elbow guillotine", "c": [{"t": "- Offence", "c": [{"t": "- Sit back"}, {"t": "- Roll through"}]}, {"t": "- Defence", "c": [{"t": "- Arm over high elbow"}, {"t": "- Stripping leg"}]}]}, {"t": "- High wrist guillotine", "c": [{"t": "- Offence"}, {"t": "- Defence"}]}, {"t": "- Anaconda", "c": [{"t": "- Offence", "c": [{"t": "- Anaconda"}]}, {"t": "- Defence", "c": [{"t": "- Arm and leg post"}]}]}, {"t": "- Boltcutter", "c": [{"t": "- Offence", "c": [{"t": "- D\u00e2\u0080\u0099arce"}, {"t": "- Japanese Necktie", "c": [{"t": "- Hook leg"}]}]}, {"t": "- Defence", "c": [{"t": "- Push off head"}]}]}, {"t": "- D\u00e2\u0080\u0099arce", "c": [{"t": "- Offence", "c": [{"t": "- Bolt cutter"}, {"t": "- Turtle"}]}, {"t": "- Defence", "c": [{"t": "- Escape arm"}]}]}, {"t": "- Japanese Necktie", "c": [{"t": "- Offence", "c": [{"t": "- Bolt cutter"}, {"t": "Hook leg"}]}, {"t": "- Defence", "c": [{"t": "- Clear bolt cutter"}, {"t": "- Hide foot"}]}]}, {"t": "- Head pinch", "c": [{"t": "- Offence", "c": [{"t": "- Anaconda"}]}, {"t": "- Defence", "c": [{"t": "- Leg up"}]}]}, {"t": "- Headspin", "c": [{"t": "- Offence", "c": [{"t": "- Anaconda"}]}, {"t": "- Defence", "c": [{"t": "- Leg and arm post"}]}]}]}]}, {"t": "- Mount", "c": [{"t": "- Head arm", "c": [{"t": "turtles", "c": [{"t": "- Reverse darce"}]}, {"t": "arm to mat", "c": [{"t": "switch armsweave armknee through", "c": [{"t": "- Mounted triangle"}, {"t": "- S mount", "c": [{"t": "- Arm bar"}]}]}]}]}, {"t": "- Control", "c": [{"t": "- Offence", "c": [{"t": "- Squeezing legs"}, {"t": "- Postured up"}, {"t": "- Feet position"}, {"t": "- Isolating arm"}]}, {"t": "- Defence", "c": [{"t": "- Kipping escape"}, {"t": "- Foot trap"}]}]}]}, {"t": "- Side Control", "c": [{"t": "- Defence", "c": [{"t": "- Shoulder frame", "c": [{"t": "- Dig Underhook", "c": [{"t": "- Wrestle up single leg"}, {"t": "- wrestle up dog fight"}]}, {"t": "- Bring knee shield back in"}]}, {"t": "- Knee frame"}]}, {"t": "- Offence", "c": [{"t": "- North South Choke"}, {"t": "- Darce Choke"}, {"t": "- Far side arm bar"}, {"t": "- Von flue"}, {"t": "- Near side Kimura", "c": [{"t": "- Kimura"}, {"t": "- Tarikoplata"}, {"t": "- Arm bar"}, {"t": "- Back take"}]}, {"t": "- Triangle"}]}, {"t": "to mount", "c": [{"t": "- High step to mount"}, {"t": "- Gift wrap to back"}, {"t": "- Seat belt to back"}, {"t": "- Control points", "c": [{"t": "- Tight waist"}, {"t": "- Near side underhook"}, {"t": "- Crossface"}]}]}, {"t": "- Transitions", "c": [{"t": "- Knee on belly"}]}]}, {"t": "- North South", "c": [{"t": "- Control", "c": [{"t": "- Arms inside"}, {"t": "- Behind tricep grips"}, {"t": "- Collar tie"}, {"t": "- Overback"}, {"t": "- Reverse bodylock"}]}, {"t": "- Transitions", "c": [{"t": "- Side control"}, {"t": "- Back", "c": [{"t": "- Gift wrap"}, {"t": "- Kimura"}]}, {"t": "- Front headlock"}, {"t": "- Turtle"}]}, {"t": "- Offence", "c": [{"t": "- North south choke"}, {"t": "- Kimura", "c": [{"t": "- Kimura"}, {"t": "- Tarikoplata"}, {"t": "- Arm bar"}, {"t": "- Back take"}]}, {"t": "- D\u00e2\u0080\u0099arce"}]}, {"t": "- Defence", "c": [{"t": "- Frames"}, {"t": "- Coil"}, {"t": "- Far shoulder foot hook"}, {"t": "- wrestle up"}, {"t": "- turtle"}]}]}, {"t": "- Back Control"}]}, {"title": "Guard playing", "color": "#47c8ff", "nodes": [{"t": "- Seated Guard", "c": [{"t": "- Cross Grip", "c": [{"t": "- Collar tie", "c": [{"t": "- Overback"}, {"t": "- North south"}]}]}, {"t": "- High Tripod", "c": [{"t": "- Entries"}, {"t": "- Arm and head position"}, {"t": "- Passes", "c": [{"t": "- Shoving leg down"}, {"t": "- Hip switch"}, {"t": "- Knee cut"}, {"t": "- Stepping over leg"}]}]}, {"t": "- Bodylock", "c": [{"t": "- Bodylock positioning", "c": [{"t": "- One arm deep one shallow"}, {"t": "- Tricep pressure"}, {"t": "- Head centered"}, {"t": "- Hips to ass"}, {"t": "- Pulling in"}]}, {"t": "- Passes", "c": [{"t": "- Two butterfly hooks", "c": [{"t": "- Stepping over to mount", "c": [{"t": "- mount"}]}, {"t": "- Two legs on one shin", "c": [{"t": "- side control"}]}, {"t": "- Step over to half butterfly", "c": [{"t": "- Half butterfly"}]}]}, {"t": "- Half butterfly", "c": [{"t": "- Turn hips away", "c": [{"t": "- Back step", "c": [{"t": "- side control"}]}, {"t": "- Smash pass", "c": [{"t": "- side control"}]}]}]}, {"t": "- Half guard", "c": [{"t": "- Head post windshield wiper"}, {"t": "- Climb to underhooks", "c": [{"t": "- Half guard passing"}]}]}]}, {"t": "- Dealing with defenses", "c": [{"t": "- Slipping out to closed guard", "c": [{"t": "- Pinning feet"}]}, {"t": "- Gogopalata", "c": [{"t": "- Bringing head to pummeling leg side"}]}, {"t": "- Framing head", "c": [{"t": "- Stepping over opposite side"}]}, {"t": "- Framing knees", "c": [{"t": "- Using head to create room"}]}, {"t": "- Pushing bodylock down", "c": [{"t": "- Tight bodylock"}]}, {"t": "- Underhooking arm for"}]}]}]}, {"t": "- Shin pin", "c": [{"t": "J point"}, {"t": "- Rau drag"}, {"t": "- Arm weave", "c": [{"t": "- Overback", "c": [{"t": "- North South"}]}, {"t": "- Reverse collar tie", "c": [{"t": "- North south passing"}]}]}]}, {"t": "- Reverse de la riva", "c": [{"t": "- Kiss of the dragon", "c": [{"t": "- [Crab ride]"}, {"t": "- [Wrestle up tripod rear bodylock]"}]}]}, {"t": "- De la riva", "c": [{"t": "- Baby bolo", "c": [{"t": "- [crab ride]"}, {"t": "- wrestle up tripod"}]}]}, {"t": "- Knee shield Half guard", "c": [{"t": "- [K hook Body X"}]}, {"t": "- K guard", "c": [{"t": "- [Passing foot across"}, {"t": "Crab Ride Entry]"}]}, {"t": "- Single leg X", "c": [{"t": "- Standing", "c": [{"t": "- Strip foot push knee through step leg passed to pass"}, {"t": "- Strip leg back step"}]}, {"t": "- Seated", "c": [{"t": "- Strip foot on hip hop over push pull out"}]}]}, {"t": "- X guard", "c": [{"t": "- Control foot clear other back step to pass"}, {"t": "- If wrestle up inside switch tripod"}]}, {"t": "- Outside ashi", "c": [{"t": "- Control knee line , feet off hips, knee facing inwards, shoe laces to mat", "c": [{"t": "- Smash pass"}]}, {"t": "- Knee wedge berimbolo", "c": [{"t": "- Back take"}, {"t": "- Reverse half", "c": [{"t": "- Twister hook arm underhook", "c": [{"t": "- Back take"}]}, {"t": "- Chair sit arm underhook"}]}]}]}, {"t": "- Butterfly ashi", "c": [{"t": "- Clear foot back step"}, {"t": "- Spin out if ankle being exposed", "c": [{"t": "- Escape"}, {"t": "- Crab ride"}]}]}, {"t": "- Reverse de la riva", "c": [{"t": "- Back step strip foot step back in", "c": [{"t": "- I point"}]}, {"t": "- Diving to crab x", "c": [{"t": "- Crab ride"}]}]}, {"t": "- De la riva", "c": [{"t": "- Turn knee outward", "c": [{"t": "- Push ankle force headquartes", "c": [{"t": "- Headquarters"}, {"t": "- High tripod"}]}, {"t": "- Knee to flooor"}]}, {"t": "- Diving leg drag", "c": [{"t": "- Hammer down"}]}, {"t": "- Diving crab x", "c": [{"t": "- Crab ride"}]}]}, {"t": "- K guard", "c": [{"t": "- Hips low on foot fight feet", "c": [{"t": "- North south passing"}, {"t": "- Underhook mount"}]}, {"t": "- Crab shin wedge", "c": [{"t": "- Crab ride"}]}]}, {"t": "- Knee shield half guard", "c": [{"t": "- Standard", "c": [{"t": "- Sprawling split squat"}]}, {"t": "- Z guard", "c": [{"t": "- Low head split squat"}]}]}, {"t": "- Half butterfly", "c": [{"t": "- High tripod"}, {"t": "- Bodylock"}]}, {"t": "- Butterfly guard", "c": [{"t": "- Bodylock"}, {"t": "- High tripod"}, {"t": "shoulder crunch", "c": [{"t": "- Early prevention"}, {"t": "- Shoulder crunch defence"}, {"t": "- Double unders", "c": [{"t": "- Posture up pummel underhook"}, {"t": "- Arms above head", "c": [{"t": "- Elbows back", "c": [{"t": "- Posture up pummel underhook"}, {"t": "- Foot on hip", "c": [{"t": "- Hip switch", "c": [{"t": "- Posture up pummel underhook"}]}]}]}]}]}, {"t": "- Wrestle ups"}, {"t": "Subtopic"}]}]}, {"t": "- Half Guard Passing", "c": [{"t": "- Chest to chest", "c": [{"t": "- Upper body controls", "c": [{"t": "- Crossface"}, {"t": "- Double unders"}, {"t": "- Near side underhook"}, {"t": "- Head positioning"}]}, {"t": "- Passes", "c": [{"t": "- Windshield wiper", "c": [{"t": "- Three quarter mount", "c": [{"t": "- Mount"}]}, {"t": "- Knee cut"}]}]}]}]}, {"t": "- Quarter guard", "c": [{"t": "- Side control"}, {"t": "- Dealing with defences", "c": [{"t": "- John wayne sweep", "c": [{"t": "- Knees facing same way"}]}, {"t": "- Kimura", "c": [{"t": "- Early prevention"}, {"t": "- Clearing kimura"}]}, {"t": "- Underhook wrestle up", "c": [{"t": "- overhook back step"}, {"t": "- Early prevention hip clamp"}]}]}, {"t": "- Knee shield", "c": [{"t": "- Split squat camping", "c": [{"t": "- Sprawling", "c": [{"t": "- Rau drag"}, {"t": "- Smashing knee shield", "c": [{"t": "- Shin pin"}, {"t": "- Mount"}]}]}, {"t": "- Tripoding", "c": [{"t": "- Shin pin"}]}, {"t": "- Dealing with defences", "c": [{"t": "- Reverse de la riva", "c": [{"t": "- Back step J point"}]}, {"t": "- K hook", "c": [{"t": "- Hand positioning"}, {"t": "- Elbow blocking"}]}, {"t": "- Arm drag", "c": [{"t": "- Overback"}]}, {"t": "- Underhook wrestle up", "c": [{"t": "- Clampoing hip near side underhook"}]}]}]}]}, {"t": "- Z Guard"}, {"t": "- Half butterfly", "c": [{"t": "- High Tripod", "c": [{"t": "- Arm and head position"}, {"t": "- Passes", "c": [{"t": "- Shoving leg down"}, {"t": "- Hip switch"}, {"t": "- Knee cut"}, {"t": "- Stepping over leg"}]}]}]}]}, {"t": "- Headquarters", "c": [{"t": "- Leg drag", "c": [{"t": "- Side control"}]}, {"t": "- Over/under", "c": [{"t": "- Control points", "c": [{"t": "- Head pressure into hip"}, {"t": "- Straight arms"}]}]}, {"t": "- Smash pass", "c": [{"t": "- Side control"}]}, {"t": "- J point"}, {"t": "- Throwing leg through", "c": [{"t": "- Three quarter mount", "c": [{"t": "- Mount"}]}]}, {"t": "- High tripod"}]}, {"t": "- Closed Guard", "c": [{"t": "- Closed Guard", "c": [{"t": "- Knee through centre"}, {"t": "- Standing ankle grip underhook break", "c": [{"t": "- delariva", "c": [{"t": "- knee too floor"}, {"t": "- smash pass"}]}, {"t": "- k guard", "c": [{"t": "- control leg step out"}, {"t": "- Crab ride shin block"}]}]}, {"t": "- Standing ankle grip push"}]}]}]}, {"title": "Crab ride & Berimibolo", "color": "#34d399", "nodes": [{"t": "- Crab ride & berimbolo", "v": "https://youtu.be/_ZX2QpYZsYY", "c": [{"t": "What is crab ride?", "v": "https://youtu.be/_ZX2QpYZsYY"}, {"t": "What is a berimbolo?"}, {"t": "Entries", "c": [{"t": "Inverted North south"}]}, {"t": "Foundations", "v": "https://youtu.be/fKgXnrPQd-8", "c": [{"t": "Crab x", "v": "https://youtu.be/SeCBJnjZid4", "c": [{"t": "Knee staple", "v": "https://youtu.be/SeCBJnjZid4"}]}, {"t": "- Leg drag", "v": "https://youtu.be/fKgXnrPQd-8"}, {"t": "Hammer down", "v": "https://youtu.be/TcmqIqhDiUA"}, {"t": "- Crab knee wedge", "c": [{"t": "- Back take"}]}, {"t": "- Crab reverse x", "v": "https://youtu.be/qXd_DfldSrY", "c": [{"t": "- Leg drag", "v": "https://youtu.be/qXd_DfldSrY"}, {"t": "Knee staple", "v": "https://youtu.be/qI5yVJIFRwI"}, {"t": "- Hammer down", "c": [{"t": "- Crab knee wedge", "c": [{"t": "- Back take"}]}]}]}, {"t": "- Crab shin wedge", "v": "https://youtu.be/cai4w1F178U", "c": [{"t": "- Invert crab x", "c": [{"t": "- Knee staple", "c": [{"t": "- Side control"}]}, {"t": "- Crab knee wedge", "c": [{"t": "- Back take"}]}]}, {"t": "- Crab shin wedge", "v": "https://youtu.be/cai4w1F178U"}]}, {"t": "- Knee staple", "c": [{"t": "- Side control"}]}, {"t": "- Knee wedge berimbolo", "c": [{"t": "- Back take"}, {"t": "- Reverse half", "c": [{"t": "- Hook far arm", "c": [{"t": "- Roll opponent back through with twister hook", "c": [{"t": "- Back take"}]}, {"t": "- Chair sit for back", "c": [{"t": "- Back take"}]}]}]}, {"t": "- Far arm underhook twister hook back take", "c": [{"t": "- Back take"}]}, {"t": "- Far arm chair sit back take", "c": [{"t": "- Back take"}]}]}, {"t": "- Twister hook battle", "v": "https://youtu.be/RzGu0-anSM4", "c": [{"t": "- Kick through back take", "v": "https://youtu.be/RzGu0-anSM4"}, {"t": "- Rebolo off losing kick through", "v": "https://youtu.be/cYjpcWI_geI"}, {"t": "Double leg counter", "v": "https://youtu.be/GmfoEJ_qebg"}]}]}]}]}];
const COLORS = ['#e8ff47','#ff6b35','#a78bfa','#47c8ff','#34d399'];

// â”€â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const EXPANDED = new Set(); // shared across all views

function toggleExpanded(key) {
  if (EXPANDED.has(key)) EXPANDED.delete(key);
  else EXPANDED.add(key);
  syncAllViews();
}

function syncAllViews() {
  syncReference();
  if (window.cmSyncExpanded) window.cmSyncExpanded();
  if (window.g3dSyncExpanded) window.g3dSyncExpanded();
}

function syncReference() {
  document.querySelectorAll('.tree-item[data-key]').forEach(li => {
    if (!li.querySelector(':scope > .children')) return;
    const key = li.dataset.key;
    const exp = EXPANDED.has(key);
    li.classList.toggle('collapsed', !exp);
    const tog = li.querySelector(':scope > .node > .node-toggle');
    if (tog) tog.textContent = exp ? 'âˆ’' : '+';
  });
}

const STATE = {
  progress: {},
  notes: {},
  currentNoteKey: null,
  currentFilter: 'all',
  totalNodes: 0,
  learnedNodes: 0
};

function saveState() {
  try {
    localStorage.setItem('grapplingProgress', JSON.stringify(STATE.progress));
    localStorage.setItem('grapplingNotes', JSON.stringify(STATE.notes));
  } catch(e) {}
}

function loadState() {
  try {
    const p = localStorage.getItem('grapplingProgress');
    const n = localStorage.getItem('grapplingNotes');
    if (p) STATE.progress = JSON.parse(p);
    if (n) STATE.notes = JSON.parse(n);
  } catch(e) {}
}

function makeKey(sectionTitle, text) {
  return (sectionTitle + '|' + text).toLowerCase().replace(/\s+/g, '_');
}

function updateStats() {
  let learned = 0;
  for (const v of Object.values(STATE.progress)) {
    if (v === 'learned') learned++;
  }
  STATE.learnedNodes = learned;
  document.getElementById('learnedCount').textContent = learned;
  document.getElementById('totalCount').textContent = STATE.totalNodes;
  const pct = STATE.totalNodes > 0 ? (learned / STATE.totalNodes * 100) : 0;
  document.getElementById('progressBar').style.width = pct + '%';
}

// â”€â”€â”€ POPUP BUILDER (shared between 2D and 3D) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildPopup(popupEl, node, sectionTitle, color) {
  const key = makeKey(sectionTitle, node.t);
  const prog = STATE.progress[key] || 'none';
  const note = STATE.notes[key] || '';
  const label = node.t.replace(/^[-â€¢]\s*/, '').trim();

  const progColors = {none:'var(--text-muted)', drilling:'var(--blue)', learned:'var(--accent)'};
  const progLabels = {none:'Track', drilling:'Drilling', learned:'Learned'};
  const progNext = {none:'drilling', drilling:'learned', learned:'none'};

  popupEl.innerHTML = '';
  popupEl.style.display = 'block';

  // Header
  const hdr = document.createElement('div');
  hdr.className = 'popup-header';
  hdr.innerHTML = '<div class="popup-dot" style="background:'+color+'"></div>';
  const title = document.createElement('div');
  title.className = 'popup-title';
  title.style.color = color;
  title.textContent = label;
  const closeBtn = document.createElement('button');
  closeBtn.className = 'popup-close';
  closeBtn.textContent = 'âœ•';
  closeBtn.addEventListener('click', () => {
    popupEl.style.display = 'none';
    const vf = popupEl.querySelector('iframe');
    if (vf) vf.src = '';
  });
  hdr.appendChild(title);
  hdr.appendChild(closeBtn);
  popupEl.appendChild(hdr);

  // Section label
  const sec = document.createElement('div');
  sec.className = 'popup-section';
  sec.textContent = sectionTitle;
  popupEl.appendChild(sec);

  // Actions row
  const actions = document.createElement('div');
  actions.className = 'popup-actions';

  // Progress pill
  const pill = document.createElement('button');
  pill.className = 'progress-pill' + (prog !== 'none' ? ' ' + prog : '');
  pill.textContent = progLabels[prog];
  pill.addEventListener('click', () => {
    const cur = STATE.progress[key] || 'none';
    const next = progNext[cur];
    if (next === 'none') delete STATE.progress[key];
    else STATE.progress[key] = next;
    saveState();
    updateStats();
    buildPopup(popupEl, node, sectionTitle, color);
    refreshAllViews();
  });
  actions.appendChild(pill);

  // Instructional video
  if (node.v) {
    const vb = document.createElement('button');
    vb.className = 'btn-video';
    vb.textContent = 'ðŸ“– Instructional';
    vb.addEventListener('click', () => {
      const vidWrap = popupEl.querySelector('.popup-video');
      const vf = popupEl.querySelector('iframe');
      if (vidWrap.style.display === 'block') {
        vidWrap.style.display = 'none'; vf.src = ''; vb.textContent = 'ðŸ“– Instructional';
      } else {
        const vidId = node.v.split('/').pop().split('?')[0];
        vf.src = 'https://www.youtube.com/embed/' + vidId + '?autoplay=1';
        vidWrap.style.display = 'block'; vb.textContent = 'âœ• Close';
      }
    });
    actions.appendChild(vb);
  }

  // Live video
  if (node.l) {
    const lb = document.createElement('button');
    lb.className = 'btn-video btn-live';
    lb.textContent = 'ðŸŽ¥ Live';
    lb.addEventListener('click', () => {
      const vidWrap = popupEl.querySelector('.popup-video');
      const vf = popupEl.querySelector('iframe');
      if (vidWrap.style.display === 'block') {
        vidWrap.style.display = 'none'; vf.src = ''; lb.textContent = 'ðŸŽ¥ Live';
      } else {
        const vidId = node.l.split('/').pop().split('?')[0];
        vf.src = 'https://www.youtube.com/embed/' + vidId + '?autoplay=1';
        vidWrap.style.display = 'block'; lb.textContent = 'âœ• Close';
      }
    });
    actions.appendChild(lb);
  }

  // Note button
  const nb = document.createElement('button');
  nb.className = 'btn-note' + (note ? ' has-note' : '');
  nb.textContent = 'âœŽ';
  nb.title = 'Note';
  nb.addEventListener('click', () => {
    const na = popupEl.querySelector('.popup-note-area');
    na.style.display = na.style.display === 'block' ? 'none' : 'block';
  });
  actions.appendChild(nb);

  // Open in ref
  const rb = document.createElement('button');
  rb.className = 'btn-note';
  rb.textContent = 'â†’ Ref';
  rb.style.marginLeft = 'auto';
  rb.addEventListener('click', () => {
    popupEl.style.display = 'none';
    switchToReferenceNode(label);
  });
  actions.appendChild(rb);
  popupEl.appendChild(actions);

  // Video area
  const vidWrap = document.createElement('div');
  vidWrap.className = 'popup-video';
  vidWrap.innerHTML = '<div class="popup-video-inner"><iframe allowfullscreen allow="autoplay; encrypted-media"></iframe></div>';
  popupEl.appendChild(vidWrap);

  // Note area
  const na = document.createElement('div');
  na.className = 'popup-note-area';
  na.innerHTML = '<textarea placeholder="Add notes...">' + (note||'') + '</textarea>';
  const ns = document.createElement('button');
  ns.className = 'popup-note-save';
  ns.textContent = 'Save Note';
  ns.addEventListener('click', () => {
    const val = na.querySelector('textarea').value.trim();
    if (val) STATE.notes[key] = val;
    else delete STATE.notes[key];
    saveState();
    nb.className = 'btn-note' + (val ? ' has-note' : '');
    refreshAllViews();
  });
  na.appendChild(ns);
  popupEl.appendChild(na);
}

// â”€â”€â”€ REFERENCE VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildNode(node, sectionTitle, depth, parentUl) {
  const li = document.createElement('li');
  li.className = 'tree-item';
  const key = makeKey(sectionTitle, node.t);
  li.dataset.key = key;
  li.dataset.hasVideo = (node.v || node.l) ? '1' : '0';

  const nodeDiv = document.createElement('div');
  nodeDiv.className = 'node';
  const indent = depth * 20;
  nodeDiv.style.paddingLeft = (indent + 8) + 'px';

  const hasChildren = node.c && node.c.length > 0;
  const toggle = document.createElement('div');
  toggle.className = hasChildren ? 'node-toggle' : 'node-toggle leaf';
  toggle.textContent = hasChildren ? 'âˆ’' : 'Â·';

  const content = document.createElement('div');
  content.className = 'node-content';

  const label = document.createElement('span');
  label.className = (node.v || node.l) ? 'node-label has-video' : 'node-label';
  label.textContent = node.t;
  content.appendChild(label);

  const actions = document.createElement('div');
  actions.className = 'node-actions';

  // Video buttons
  if (node.v) {
    const vBtn = document.createElement('button');
    vBtn.className = 'btn-video';
    vBtn.textContent = 'ðŸ“– Instructional';
    vBtn.addEventListener('click', e => {
      e.stopPropagation();
      const vidId = node.v.split('/').pop().split('?')[0];
      const existing = li.querySelector('.inline-player-i');
      if (existing) { existing.remove(); vBtn.textContent = 'ðŸ“– Instructional'; return; }
      const pw = document.createElement('div');
      pw.className = 'inline-player inline-player-i';
      pw.style.cssText = 'padding:8px 0 4px ' + (indent+28) + 'px;';
      pw.innerHTML = '<div style="position:relative;padding-bottom:56.25%;height:0;overflow:hidden;border-radius:4px;border:1px solid var(--border);"><iframe src="https://www.youtube.com/embed/'+vidId+'?autoplay=1" style="position:absolute;top:0;left:0;width:100%;height:100%;border:0;" allowfullscreen allow="autoplay; encrypted-media"></iframe></div>';
      li.appendChild(pw);
      vBtn.textContent = 'âœ• Close';
    });
    actions.appendChild(vBtn);
  }

  if (node.l) {
    const lBtn = document.createElement('button');
    lBtn.className = 'btn-video btn-live';
    lBtn.textContent = 'ðŸŽ¥ Live';
    lBtn.addEventListener('click', e => {
      e.stopPropagation();
      const vidId = node.l.split('/').pop().split('?')[0];
      const existing = li.querySelector('.inline-player-l');
      if (existing) { existing.remove(); lBtn.textContent = 'ðŸŽ¥ Live'; return; }
      const pw = document.createElement('div');
      pw.className = 'inline-player inline-player-l';
      pw.style.cssText = 'padding:8px 0 4px ' + (indent+28) + 'px;';
      pw.innerHTML = '<div style="position:relative;padding-bottom:56.25%;height:0;overflow:hidden;border-radius:4px;border:1px solid var(--border);"><iframe src="https://www.youtube.com/embed/'+vidId+'?autoplay=1" style="position:absolute;top:0;left:0;width:100%;height:100%;border:0;" allowfullscreen allow="autoplay; encrypted-media"></iframe></div>';
      li.appendChild(pw);
      lBtn.textContent = 'âœ• Close';
    });
    actions.appendChild(lBtn);
  }

  // Progress pill
  const prog = document.createElement('div');
  prog.className = 'progress-pill';
  const curProg = STATE.progress[key] || 'none';
  if (curProg === 'drilling') { prog.classList.add('drilling'); prog.textContent = 'Drilling'; }
  else if (curProg === 'learned') { prog.classList.add('learned'); prog.textContent = 'Learned'; }
  else prog.textContent = 'Track';
  prog.addEventListener('click', e => {
    e.stopPropagation();
    const cur = STATE.progress[key] || 'none';
    const next = {none:'drilling',drilling:'learned',learned:'none'}[cur];
    if (next === 'none') { delete STATE.progress[key]; prog.className = 'progress-pill'; prog.textContent = 'Track'; }
    else if (next === 'drilling') { STATE.progress[key] = 'drilling'; prog.className = 'progress-pill drilling'; prog.textContent = 'Drilling'; }
    else { STATE.progress[key] = 'learned'; prog.className = 'progress-pill learned'; prog.textContent = 'Learned'; }
    li.dataset.progress = next;
    saveState(); updateStats(); refreshAllViews();
  });
  li.dataset.progress = curProg;
  actions.appendChild(prog);

  // Note button
  const noteBtn = document.createElement('button');
  noteBtn.className = STATE.notes[key] ? 'btn-note has-note' : 'btn-note';
  noteBtn.textContent = 'âœŽ';
  noteBtn.addEventListener('click', e => { e.stopPropagation(); openNotePanel(key, node.t); });
  li.dataset.hasNote = STATE.notes[key] ? '1' : '0';
  actions.appendChild(noteBtn);

  content.appendChild(actions);
  nodeDiv.appendChild(toggle);
  nodeDiv.appendChild(content);
  li.appendChild(nodeDiv);

  if (hasChildren) {
    const childUl = document.createElement('ul');
    childUl.className = 'children';
    node.c.forEach(child => buildNode(child, sectionTitle, depth + 1, childUl));
    li.appendChild(childUl);
    li.classList.add('collapsed'); toggle.textContent = '+';
    const doToggle = e => { if(e) e.stopPropagation(); toggleExpanded(key); };
    toggle.addEventListener('click', doToggle);
    nodeDiv.addEventListener('click', doToggle);
  }

  STATE.totalNodes++;
  parentUl.appendChild(li);
}

function buildSections() {
  const container = document.getElementById('sections');
  container.innerHTML = '';
  STATE.totalNodes = 0;
  SECTIONS.forEach((section, si) => {
    const div = document.createElement('div');
    div.className = 'section collapsed';
    div.dataset.section = section.title;
    const header = document.createElement('div');
    header.className = 'section-header';
    header.innerHTML = '<div class="section-dot" style="background:'+section.color+'"></div><div class="section-title">'+section.title+'</div><span class="view-in-map-btn" onclick="event.stopPropagation();switchToTab(&quot;map&quot;)">&#x1F5FA;</span><div class="section-chevron">&#9662;</div>';
    header.addEventListener('click', e => {
      if (e.target.classList.contains('view-in-map-btn')) return;
      div.classList.toggle('collapsed');
    });
    const body = document.createElement('div');
    body.className = 'section-body';
    const ul = document.createElement('ul');
    ul.className = 'tree';
    section.nodes.forEach(node => buildNode(node, section.title, 0, ul));
    body.appendChild(ul);
    div.appendChild(header);
    div.appendChild(body);
    container.appendChild(div);
  });
  updateStats();
}

// â”€â”€â”€ NOTE PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openNotePanel(key, title) {
  STATE.currentNoteKey = key;
  document.getElementById('notePanelTitle').textContent = title;
  document.getElementById('noteTextarea').value = STATE.notes[key] || '';
  document.getElementById('notePanel').classList.add('open');
  document.getElementById('overlay').classList.add('active');
  setTimeout(() => document.getElementById('noteTextarea').focus(), 300);
}
function closeNotePanel() {
  document.getElementById('notePanel').classList.remove('open');
  document.getElementById('overlay').classList.remove('active');
  STATE.currentNoteKey = null;
}
document.getElementById('noteSaveBtn').addEventListener('click', () => {
  const key = STATE.currentNoteKey;
  const val = document.getElementById('noteTextarea').value.trim();
  if (val) STATE.notes[key] = val; else delete STATE.notes[key];
  saveState();
  const li = document.querySelector('[data-key="'+key+'"]');
  if (li) {
    li.dataset.hasNote = val ? '1' : '0';
    const nb = li.querySelector('.btn-note');
    if (nb) nb.className = val ? 'btn-note has-note' : 'btn-note';
  }
  closeNotePanel();
  refreshAllViews();
});
document.getElementById('noteClearBtn').addEventListener('click', () => { document.getElementById('noteTextarea').value = ''; });
document.getElementById('noteCloseBtn').addEventListener('click', closeNotePanel);
document.getElementById('overlay').addEventListener('click', closeNotePanel);

// â”€â”€â”€ SEARCH (Reference) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('refSearch').addEventListener('input', function() {
  const q = this.value.toLowerCase().trim();
  document.querySelectorAll('.tree-item').forEach(li => {
    const label = li.querySelector('.node-label');
    if (!label) return;
    const match = !q || label.textContent.toLowerCase().includes(q);
    li.style.display = match ? '' : 'none';
  });
  document.querySelectorAll('.section').forEach(sec => {
    const visible = Array.from(sec.querySelectorAll('.tree-item')).some(li => li.style.display !== 'none');
    sec.style.display = visible ? '' : 'none';
    if (q && visible) sec.classList.remove('collapsed');
  });
});

// â”€â”€â”€ FILTER (Reference) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll('.tab[data-filter]').forEach(tab => {
  if (!tab.classList.contains('cm-filter') && !tab.classList.contains('g3d-filter')) {
    tab.addEventListener('click', function() {
      document.querySelectorAll('.tab[data-filter]:not(.cm-filter):not(.g3d-filter)').forEach(t => t.classList.remove('active'));
      this.classList.add('active');
      applyRefFilter(this.dataset.filter);
    });
  }
});
function applyRefFilter(filter) {
  STATE.currentFilter = filter;
  document.querySelectorAll('.tree-item').forEach(li => {
    let show = true;
    if (filter === 'drilling') show = li.dataset.progress === 'drilling';
    else if (filter === 'learned') show = li.dataset.progress === 'learned';
    else if (filter === 'video') show = li.dataset.hasVideo === '1';
    li.style.display = show ? '' : 'none';
  });
  document.querySelectorAll('.section').forEach(sec => {
    const visible = Array.from(sec.querySelectorAll('.tree-item')).some(li => li.style.display !== 'none');
    sec.style.display = visible ? '' : 'none';
    if (filter !== 'all' && visible) sec.classList.remove('collapsed');
  });
}

// â”€â”€â”€ COLLAPSE ALL (Reference) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('refCollapseAll').addEventListener('click', () => {
  EXPANDED.clear();
  document.querySelectorAll('.section').forEach(s => s.classList.add('collapsed'));
  syncAllViews();
});

// â”€â”€â”€ VIEW SWITCHING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchToTab(view) {
  document.querySelectorAll('.view-tab').forEach(t => t.classList.remove('active'));
  const btn = document.querySelector('[data-view="'+view+'"]');
  if (btn) btn.classList.add('active');
  document.getElementById('referenceView').style.display = view === 'reference' ? 'block' : 'none';
  document.getElementById('customMapView').style.display = view === 'custommap' ? 'flex' : 'none';
  document.getElementById('customMapView').style.flexDirection = 'column';
  document.getElementById('graph3dView').style.display = view === 'graph3d' ? 'flex' : 'none';
  document.getElementById('graph3dView').style.flexDirection = 'column';
  if (view === 'custommap') requestAnimationFrame(()=>requestAnimationFrame(initCustomMap));
  if (view === 'graph3d') requestAnimationFrame(()=>requestAnimationFrame(initGraph3D));
  window.scrollTo(0, 0);
}
document.querySelectorAll('.view-tab').forEach(tab => {
  tab.addEventListener('click', function() { switchToTab(this.dataset.view); });
});
function switchToReferenceNode(text) {
  switchToTab('reference');
  document.querySelectorAll('.section').forEach(s => s.classList.remove('collapsed'));
  document.querySelectorAll('.tree-item').forEach(li => {
    li.classList.remove('collapsed');
    const tog = li.querySelector('.node-toggle');
    if (tog && !tog.classList.contains('leaf')) tog.textContent = 'âˆ’';
  });
  setTimeout(() => {
    let found = null;
    const needle = text.trim().toLowerCase().slice(0, 20);
    document.querySelectorAll('.node-label').forEach(lbl => {
      if (!found && lbl.textContent.trim().replace(/^[-â€¢]\s*/,'').toLowerCase().startsWith(needle.slice(0,15))) found = lbl;
    });
    if (found) {
      found.scrollIntoView({behavior:'smooth',block:'center'});
      found.style.background = 'rgba(232,255,71,0.2)';
      found.style.borderRadius = '3px'; found.style.padding = '0 3px';
      setTimeout(() => { found.style.background=''; found.style.padding=''; }, 2500);
    }
  }, 300);
}

// â”€â”€â”€ REFRESH (called after state changes) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function refreshAllViews() {
  // Refresh reference progress pills
  document.querySelectorAll('.tree-item').forEach(li => {
    const key = li.dataset.key;
    if (!key) return;
    const prog = STATE.progress[key] || 'none';
    li.dataset.progress = prog;
    const pill = li.querySelector('.progress-pill');
    if (pill) {
      pill.className = 'progress-pill' + (prog !== 'none' ? ' '+prog : '');
      pill.textContent = {none:'Track',drilling:'Drilling',learned:'Learned'}[prog];
    }
    const nb = li.querySelector('.btn-note');
    if (nb) nb.className = STATE.notes[key] ? 'btn-note has-note' : 'btn-note';
    li.dataset.hasNote = STATE.notes[key] ? '1' : '0';
  });
  // Update 2D map node colours if initialized
  if (window.cmRefreshNodes) window.cmRefreshNodes();
  // Update 3D node colours if initialized
  if (window.g3dRefreshNodes) window.g3dRefreshNodes();
}

// â”€â”€â”€ 2D CUSTOM MAP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.initCustomMap = (function() {
  let ready = false;
  let tx = 0, ty = 0, sc = 0.72;
  let panX = 0, panY = 0, panning = false;
  const NS = 'http://www.w3.org/2000/svg';
  const reg = {}; // key -> {bg, txt, toggleTxt, childG, ...}

  function el(tag, attrs, parent) {
    const e = document.createElementNS(NS, tag);
    for (const [k,v] of Object.entries(attrs||{})) e.setAttribute(k,v);
    if (parent) parent.appendChild(e); return e;
  }

  function applyT() {
    const g = document.getElementById('cmRoot');
    if (g) g.setAttribute('transform', `translate(${tx},${ty}) scale(${sc})`);
  }

  // Line from point (x1,y1) to edge of rect centered at (x2,y2) with dims w,h
  function lineToBoxEdge(x1,y1, x2,y2, w,h) {
    const dx = x2-x1, dy = y2-y1;
    if (!dx && !dy) return {x:x2, y:y2};
    // How far along the direction vector until we hit the box boundary
    const scaleX = dx ? (w/2) / Math.abs(dx) : Infinity;
    const scaleY = dy ? (h/2) / Math.abs(dy) : Infinity;
    const t = Math.min(scaleX, scaleY);
    return { x: x2 - dx*t, y: y2 - dy*t };
  }

  function lineToCircleEdge(x1,y1, x2,y2, r) {
    const dx = x1-x2, dy = y1-y2, len = Math.sqrt(dx*dx+dy*dy)||1;
    return { x: x2 + dx/len*r, y: y2 + dy/len*r };
  }

  function drawLine(parent, ax,ay, bx,by, stroke, sw, dashed) {
    el('line', {x1:ax,y1:ay,x2:bx,y2:by,
      stroke, 'stroke-width':sw,
      'stroke-dasharray': dashed?'5,3':'none',
      'stroke-linecap':'round'}, parent);
  }

  function progColor(key) {
    const p = STATE.progress[key]||'none';
    return p==='learned'?'#e8ff47':p==='drilling'?'#47c8ff':null;
  }

  function refreshReg(r) {
    const pc = progColor(r.key), d=r.depth, c=r.sectionColor, hv=r.hasVideo;
    r.bg.setAttribute('fill', pc ? pc+'22' : (d===1?c+'1a':'#0f1218'));
    r.bg.setAttribute('stroke', pc||(d<=2?c:(hv?'#ff6b35':'#1e2535')));
    r.txt.setAttribute('fill', pc||(d===1?c:(hv?'#ff9966':'#6070a0')));
  }

  window.cmRefreshAll = function() { for (const r of Object.values(reg)) refreshReg(r); };
  window.cmSyncExpanded = function() {
    for (const [key, r] of Object.entries(reg)) {
      if (!r.childG) continue;
      const exp = EXPANDED.has(key);
      r.childG.setAttribute('visibility', exp?'visible':'hidden');
      if (r.toggleTxt) r.toggleTxt.textContent = exp?'âˆ’':'+';
    }
  };

  function nodeSize(depth) {
    // Returns {w, h} - generous sizing so text fits
    const ws = [0, 160, 140, 120, 108, 96, 86];
    const hs = [0,  36,  28,  24,  22,  20, 18];
    const i = Math.min(depth, ws.length-1);
    return { w: ws[i]||86, h: hs[i]||18 };
  }

  function drawNode(linesG, nodesG, nd, x, y, angle, depth, sectionColor, sectionTitle, parentX, parentY, parentW, parentH) {
    const text = nd.t.replace(/^[-â€¢]\s*/,'').trim();
    const key = makeKey(sectionTitle, nd.t);
    const hv = !!(nd.v||nd.l);
    const hasKids = !!(nd.c&&nd.c.length);
    const {w, h} = nodeSize(depth);
    const fs = depth===1?13:depth===2?11:depth===3?10:9;

    // Draw line from parent edge to this node edge
    if (parentX !== undefined) {
      const pc = progColor(key);
      const stroke = pc || (sectionColor + (depth<=2?'cc':'66'));
      const sw = depth===1?2:depth===2?1.5:1;
      // From parent box edge toward this node
      const start = lineToBoxEdge(x, y, parentX, parentY, parentW, parentH);
      // To this box edge from parent
      const end_ = lineToBoxEdge(parentX, parentY, x, y, w, h);
      drawLine(linesG, start.x, start.y, end_.x, end_.y, stroke, sw, STATE.progress[key]==='drilling');
    }

    // Node group (just visual, no children)
    const nodeG = el('g', {cursor:'pointer'}, nodesG);
    const pc0 = progColor(key);
    const bg = el('rect', {
      x:x-w/2, y:y-h/2, width:w, height:h, rx:depth===1?5:3,
      fill: pc0?pc0+'22':(depth===1?sectionColor+'1a':'#0f1218'),
      stroke: pc0||(depth<=2?sectionColor:(hv?'#ff6b35':'#1e2535')),
      'stroke-width': depth===1?1.5:1
    }, nodeG);

    const txt = el('text', {
      x, y:y+1, 'text-anchor':'middle', 'dominant-baseline':'middle',
      fill: pc0||(depth===1?sectionColor:(hv?'#ff9966':'#6070a0')),
      'font-size':fs,
      'font-family': depth===1?'Bebas Neue,sans-serif':'DM Mono,monospace',
      'letter-spacing': depth===1?'1.5':'0',
      'pointer-events':'none'
    }, nodeG);
    // Fit text inside box
    const maxChars = Math.floor((w-10) / (fs*0.58));
    txt.textContent = text.length > maxChars ? text.slice(0,maxChars-1)+'â€¦' : text;

    if (hv) el('circle',{cx:x+w/2-5,cy:y-h/2+5,r:3,fill:'#ff6b35'},nodeG);
    if (STATE.notes[key]) el('circle',{cx:x+w/2-5,cy:y+h/2-5,r:2.5,fill:'#a78bfa'},nodeG);

    // Children group
    let childG = null, toggleTxt = null;
    if (hasKids) {
      const exp = EXPANDED.has(key);
      // childG goes into a SEPARATE group that sits between linesG and nodesG
      // We'll pass separate line/node groups for children
      childG = el('g', {visibility: exp?'visible':'hidden'}, nodesG.parentNode);
      const childLinesG = el('g', {}, childG);
      const childNodesG = el('g', {}, childG);

      // Toggle button
      const bx = x+w/2+12, by = y;
      el('circle',{cx:bx,cy:by,r:7,fill:'#13161e',stroke:sectionColor+'88','stroke-width':1.2},nodeG);
      toggleTxt = el('text',{x:bx,y:by+1,'text-anchor':'middle','dominant-baseline':'middle',
        fill:sectionColor,'font-size':10,'font-weight':'bold','pointer-events':'none',
        'font-family':'DM Mono,monospace'},nodeG);
      toggleTxt.textContent = exp?'âˆ’':'+';

      // Place children radially
      const totalLeaves = nd.c.reduce((s,c)=>s+countLeaves(c),0);
      // Spread angle scales with number of children so they don't overlap
      const spread = Math.min(Math.PI*1.4, Math.max(0.5, nd.c.length*0.45));
      // Distance scales so arc length between nodes is at least nodeWidth+padding
      const {w:nw} = nodeSize(depth+1);
      const minDist = depth===1?180:depth===2?150:120;
      const arcDist = nd.c.length > 1 ? Math.max(minDist, (nw+20)*nd.c.length/(spread)) : minDist;
      const dist = Math.min(arcDist, depth===1?340:depth===2?280:220);
      let leafOff = 0;
      nd.c.forEach(child => {
        const lv = countLeaves(child);
        const ca = nd.c.length>1 ? angle-spread/2+(leafOff+lv/2)/totalLeaves*spread : angle;
        leafOff += lv;
        const cx2 = x + Math.cos(ca)*dist;
        const cy2 = y + Math.sin(ca)*dist;
        drawNode(childLinesG, childNodesG, child, cx2, cy2, ca, depth+1, sectionColor, sectionTitle, x, y, w, h);
      });
    }

    reg[key] = {bg, txt, toggleTxt, childG, key, sectionColor, depth, hasVideo:hv, nd};

    // Hover / click
    nodeG.addEventListener('mouseenter',()=>{
      bg.setAttribute('fill',depth===1?sectionColor+'33':'#1e2535');
      bg.setAttribute('stroke',sectionColor);
      txt.setAttribute('fill','#dde1ed');
    });
    nodeG.addEventListener('mouseleave',()=>refreshReg(reg[key]));
    nodeG.addEventListener('click',e=>{
      e.stopPropagation();
      if (hasKids) toggleExpanded(key);
      else { let si=0;SECTIONS.forEach((s,i)=>{if(s.title===sectionTitle)si=i;});buildPopup(document.getElementById('cmPopup'),nd,sectionTitle,COLORS[si%COLORS.length]); }
    });
    if (hasKids) {
      const tb = el('rect',{x:x+w/2+5,y:y-10,width:20,height:20,fill:'transparent',cursor:'pointer'},nodeG);
      tb.addEventListener('click',e=>{e.stopPropagation();toggleExpanded(key);});
    }
  }

  function countLeaves(nd) {
    if(!nd.c||!nd.c.length) return 1;
    return nd.c.reduce((s,c)=>s+countLeaves(c),0);
  }

  return function() {
    const wrap = document.getElementById('cmCanvas');
    const W = wrap.clientWidth, H = wrap.clientHeight;
    if (!W||!H) { setTimeout(initCustomMap,50); return; }

    if (!ready) {
      ready = true;
      const svg = document.getElementById('cmSvg');
      svg.setAttribute('width',W); svg.setAttribute('height',H);
      svg.style.cssText = `width:${W}px;height:${H}px;`;

      const root = document.createElementNS(NS,'g');
      root.id = 'cmRoot'; svg.appendChild(root);

      // Lines layer behind nodes layer
      const linesLayer = el('g',{},root);
      const nodesLayer = el('g',{},root);

      const cx=W/2, cy=H/2;

      // Root circle
      el('circle',{cx,cy,r:52,fill:'#13161e',stroke:'#8890a8','stroke-width':2},nodesLayer);
      const rt = el('text',{x:cx,y:cy,'text-anchor':'middle','dominant-baseline':'middle',
        fill:'#8890a8','font-family':'Bebas Neue,sans-serif','font-size':14,'letter-spacing':3,'pointer-events':'none'},nodesLayer);
      rt.textContent='GRAPPLING';

      SECTIONS.forEach((sec,si)=>{
        const angle = (si/SECTIONS.length)*Math.PI*2 - Math.PI/2;
        const dist = 250;
        const sx = cx+Math.cos(angle)*dist, sy = cy+Math.sin(angle)*dist;
        const color = COLORS[si%COLORS.length];
        const {w,h} = nodeSize(1);

        // Line from circle edge to section box edge
        const circleEdge = lineToCircleEdge(sx,sy,cx,cy,54);
        const boxEdge = lineToBoxEdge(cx,cy,sx,sy,w,h);
        drawLine(linesLayer, circleEdge.x,circleEdge.y, boxEdge.x,boxEdge.y, color+'88', 2, false);

        drawNode(linesLayer, nodesLayer, {t:sec.title,c:sec.nodes}, sx,sy, angle, 1, color, sec.title);
      });

      applyT();

      // Pan / zoom
      wrap.addEventListener('mousedown',e=>{panning=true;panX=e.clientX;panY=e.clientY;});
      window.addEventListener('mousemove',e=>{if(!panning)return;tx+=e.clientX-panX;ty+=e.clientY-panY;panX=e.clientX;panY=e.clientY;applyT();});
      window.addEventListener('mouseup',()=>{panning=false;});
      wrap.addEventListener('wheel',e=>{
        e.preventDefault();
        const r=wrap.getBoundingClientRect(),mx=e.clientX-r.left,my=e.clientY-r.top;
        const f=e.deltaY>0?0.88:1.13,ns=Math.min(Math.max(sc*f,0.1),5);
        tx=mx-(mx-tx)*(ns/sc);ty=my-(my-ty)*(ns/sc);sc=ns;applyT();
      },{passive:false});
      document.getElementById('cmZoomIn').addEventListener('click',()=>{sc=Math.min(sc*1.2,5);applyT();});
      document.getElementById('cmZoomOut').addEventListener('click',()=>{sc=Math.max(sc*0.83,0.1);applyT();});
      document.getElementById('cmReset').addEventListener('click',()=>{tx=0;ty=0;sc=0.72;applyT();});
      document.getElementById('cmCollapseAll').addEventListener('click',()=>{EXPANDED.clear();syncAllViews();});
      document.getElementById('cmExpandAll').addEventListener('click',()=>{
        function addAll(nd,st){const k=makeKey(st,nd.t);if(nd.c&&nd.c.length){EXPANDED.add(k);nd.c.forEach(c=>addAll(c,st));}}
        SECTIONS.forEach(s=>s.nodes.forEach(n=>addAll(n,s.title)));syncAllViews();
      });
      document.querySelectorAll('.cm-filter').forEach(tab=>{
        tab.addEventListener('click',function(){
          document.querySelectorAll('.cm-filter').forEach(t=>t.classList.remove('active'));this.classList.add('active');
          const f=this.dataset.filter;
          Object.values(reg).forEach(r=>{const p=STATE.progress[r.key]||'none',show=f==='all'||(f==='drilling'&&p==='drilling')||(f==='learned'&&p==='learned');r.bg.style.opacity=show?'1':'0.12';r.txt.style.opacity=show?'1':'0.12';});
        });
      });
      document.getElementById('cmSearch').addEventListener('input',function(){
        const q=this.value.toLowerCase();Object.values(reg).forEach(r=>{const show=!q||r.nd.t.toLowerCase().includes(q);r.bg.style.opacity=show?'1':'0.1';r.txt.style.opacity=show?'1':'0.1';});
      });
    } else {
      window.cmSyncExpanded();
      window.cmRefreshAll();
    }
  };
})();

// â”€â”€â”€ 3D GRAPH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.initGraph3D = (function() {
  let ready = false;
  let renderer, camera, scene, pivot;
  let rotX=0,rotY=0,tRX=0,tRY=0,zoom=600,tZ=600;
  const meshMap={},lineMap={},nodeMap={};
  let allNodes=[], allMeshes=[];

  function buildTree() {
    const CINT=[0xe8ff47,0xff6b35,0xa78bfa,0x47c8ff,0x34d399];
    function fibSphere(n,r){
      const pts=[],phi=Math.PI*(3-Math.sqrt(5));
      for(let i=0;i<n;i++){const y=1-(i/(n-1))*2,rad=Math.sqrt(1-y*y),t=phi*i;pts.push([Math.cos(t)*rad*r,y*r,Math.sin(t)*rad*r]);}
      return pts;
    }
    const root={id:'root',label:'Grappling',key:'root',si:-1,sectionTitle:'',x:0,y:0,z:0,size:16,color:0x8890a8,hv:false,parentId:null,node:null,childIds:[]};
    allNodes.push(root); nodeMap.root=root;

    const sp=fibSphere(SECTIONS.length,220);
    SECTIONS.forEach((sec,si)=>{
      const p=sp[si],sId='s'+si;
      const sn={id:sId,label:sec.title,key:makeKey(sec.title,sec.title),si,sectionTitle:sec.title,
        x:p[0],y:p[1],z:p[2],size:10,color:CINT[si%5],hv:false,parentId:'root',childIds:[],visible:true,node:{t:sec.title,c:sec.nodes}};
      allNodes.push(sn); nodeMap[sId]=sn; root.childIds.push(sId);

      function addKids(nd,pid,dep){
        if(!nd.c||!nd.c.length)return;
        const par=nodeMap[pid],spread=Math.max(35,130-dep*20);
        nd.c.forEach((ch,ci)=>{
          const nId=pid+'k'+ci;
          const a1=Math.random()*Math.PI*2,a2=(0.2+Math.random()*0.6)*Math.PI;
          const cn={id:nId,label:ch.t.replace(/^[-â€¢]\s*/,'').trim(),key:makeKey(sec.title,ch.t),
            si,sectionTitle:sec.title,
            x:par.x+Math.sin(a2)*Math.cos(a1)*spread+(Math.random()-0.5)*15,
            y:par.y+Math.cos(a2)*spread*0.6+(Math.random()-0.5)*15,
            z:par.z+Math.sin(a2)*Math.sin(a1)*spread+(Math.random()-0.5)*15,
            size:Math.max(1.5,7-dep*0.9),color:CINT[si%5],hv:!!(ch.v||ch.l),
            parentId:pid,childIds:[],visible:false,node:ch};
          allNodes.push(cn); nodeMap[nId]=cn; par.childIds.push(nId);
          addKids(ch,nId,dep+1);
        });
      }
      addKids(sec,sId,1);
    });

    // Spread section nodes apart
    const vis=allNodes.filter(n=>n.parentId==='root'||!n.parentId);
    for(let it=0;it<60;it++) for(let i=1;i<vis.length;i++) for(let j=i+1;j<vis.length;j++){
      const a=vis[i],b=vis[j],dx=b.x-a.x,dy=b.y-a.y,dz=b.z-a.z;
      const d=Math.sqrt(dx*dx+dy*dy+dz*dz)||0.01,md=(a.size+b.size)*9;
      if(d<md){const f=(md-d)/d*0.3;a.x-=dx*f;a.y-=dy*f;a.z-=dz*f;b.x+=dx*f;b.y+=dy*f;b.z+=dz*f;}
    }
  }

  function nodeColor(nd,THREE){
    const p=STATE.progress[nd.key]||'none',c=new THREE.Color();
    if(p==='learned')c.setHex(0xe8ff47);else if(p==='drilling')c.setHex(0x47c8ff);else c.setHex(nd.color);
    return c;
  }

  function applyVis(nd,vis,THREE){
    nd.visible=vis;
    const m=meshMap[nd.id];
    if(m){m.visible=vis;m.material.opacity=vis?0.88:0;if(vis){const c=nodeColor(nd,THREE);m.material.color.copy(c);m.material.emissive.copy(c);}}
    const l=lineMap[nd.id];
    if(l){l.visible=vis;l.material.opacity=vis?0.3:0;}
  }

  window.g3dSyncExpanded = function(){
    const THREE=window.THREE; if(!THREE||!allNodes.length)return;
    allNodes.forEach(nd=>{
      let vis;
      if(!nd.parentId) vis=true;
      else if(nd.parentId==='root') vis=true;
      else {
        const par=nodeMap[nd.parentId];
        vis=!!(par&&par.visible&&EXPANDED.has(par.key));
      }
      if(nd.visible!==vis) applyVis(nd,vis,THREE);
    });
    // Update allMeshes list to only visible
    allMeshes=allNodes.map(n=>meshMap[n.id]).filter(m=>m&&m.visible);
  };

  window.g3dRefreshColors=function(){
    const THREE=window.THREE; if(!THREE)return;
    allNodes.forEach(nd=>{const m=meshMap[nd.id];if(!m||!nd.visible)return;const c=nodeColor(nd,THREE);m.material.color.copy(c);m.material.emissive.copy(c);});
  };

  return function(){
    const wrap=document.getElementById('g3dCanvas-wrap');
    const W=wrap.clientWidth,H=wrap.clientHeight;
    if(!W||!H){setTimeout(initGraph3D,50);return;}

    if(!ready){
      ready=true;
      const THREE=window.THREE;
      scene=new THREE.Scene();
      scene.background=new THREE.Color(0x020408);
      scene.fog=new THREE.FogExp2(0x020408,0.0006);
      camera=new THREE.PerspectiveCamera(60,W/H,0.1,3000);
      camera.position.z=600;
      const canvas=document.getElementById('g3dCanvas');
      renderer=new THREE.WebGLRenderer({canvas,antialias:true});
      renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));
      renderer.setSize(W,H);
      scene.add(new THREE.AmbientLight(0x334466,5));
      const dl=new THREE.DirectionalLight(0xffffff,2);dl.position.set(1,2,1);scene.add(dl);
      pivot=new THREE.Group();scene.add(pivot);

      buildTree();

      const col=new THREE.Color();
      allNodes.forEach(nd=>{
        const c=nodeColor(nd,THREE);
        const mat=new THREE.MeshPhongMaterial({color:c.clone(),emissive:c.clone(),emissiveIntensity:0.2,shininess:80,transparent:true,opacity:nd.visible?0.88:0});
        const mesh=new THREE.Mesh(new THREE.SphereGeometry(nd.size,8,8),mat);
        mesh.position.set(nd.x,nd.y,nd.z);mesh.visible=nd.visible;mesh.userData.nodeId=nd.id;
        pivot.add(mesh);meshMap[nd.id]=mesh;
        if(nd.visible)allMeshes.push(mesh);
        if(nd.parentId){
          const par=nodeMap[nd.parentId];
          col.setHex(nd.color);
          const lmat=new THREE.LineBasicMaterial({color:col.clone(),transparent:true,opacity:nd.visible?0.3:0});
          const line=new THREE.Line(new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(par.x,par.y,par.z),new THREE.Vector3(nd.x,nd.y,nd.z)]),lmat);
          line.visible=nd.visible;pivot.add(line);lineMap[nd.id]=line;
        }
      });

      function raycast(ex,ey){
        const rect=wrap.getBoundingClientRect();
        const mx=((ex-rect.left)/rect.width)*2-1,my=-((ey-rect.top)/rect.height)*2+1;
        camera.updateMatrixWorld();
        const ray=new THREE.Raycaster();
        ray.setFromCamera({x:mx,y:my},camera);
        return ray.intersectObjects(allMeshes);
      }

      let mx0=0,my0=0,dragged=false;
      canvas.addEventListener('mousedown',e=>{mx0=e.clientX;my0=e.clientY;dragged=false;});
      canvas.addEventListener('mousemove',e=>{
        if(e.buttons){
          if(Math.abs(e.clientX-mx0)+Math.abs(e.clientY-my0)>4)dragged=true;
          tRY+=(e.clientX-mx0)*0.004;tRX+=(e.clientY-my0)*0.004;mx0=e.clientX;my0=e.clientY;
        } else {
          const hits=raycast(e.clientX,e.clientY);
          const tip=document.getElementById('g3dTooltip');
          if(hits.length){
            const nd=nodeMap[hits[0].object.userData.nodeId];
            if(nd){
              const rect=wrap.getBoundingClientRect();
              const hc=nd.childIds&&nd.childIds.length>0;
              const exp=hc&&EXPANDED.has(nd.key);
              tip.textContent=nd.label+(nd.hv?' â–¶':'')+(hc?(exp?' [âˆ’]':' [+]'):'');
              tip.style.display='block';
              tip.style.left=(e.clientX-rect.left+14)+'px';
              tip.style.top=(e.clientY-rect.top-10)+'px';
              tip.style.color=nd.si>=0?COLORS[nd.si]:'#8890a8';
              canvas.style.cursor='pointer';
            }
          } else {tip.style.display='none';canvas.style.cursor='default';}
        }
      });
      canvas.addEventListener('mouseup',e=>{
        if(dragged)return;
        const hits=raycast(e.clientX,e.clientY);
        if(!hits.length)return;
        const nd=nodeMap[hits[0].object.userData.nodeId];
        if(!nd||nd.id==='root')return;
        if(nd.childIds&&nd.childIds.length>0){
          // expand/collapse â€” syncs all views via toggleExpanded
          toggleExpanded(nd.key);
        } else {
          const si=Math.max(0,nd.si);
          buildPopup(document.getElementById('g3dPopup'),nd.node,nd.sectionTitle,COLORS[si%COLORS.length]);
        }
      });

      canvas.addEventListener('wheel',e=>{e.preventDefault();tZ=Math.min(1500,Math.max(80,tZ+e.deltaY*0.6));},{passive:false});
      document.getElementById('g3dZoomIn').addEventListener('click',()=>{tZ=Math.max(80,tZ-80);});
      document.getElementById('g3dZoomOut').addEventListener('click',()=>{tZ=Math.min(1500,tZ+80);});
      document.getElementById('g3dReset').addEventListener('click',()=>{tRX=0;tRY=0;tZ=600;});
      document.querySelectorAll('.g3d-filter').forEach(tab=>{
        tab.addEventListener('click',function(){document.querySelectorAll('.g3d-filter').forEach(t=>t.classList.remove('active'));this.classList.add('active');
          const f=this.dataset.filter;allNodes.forEach(nd=>{const m=meshMap[nd.id];if(!m||!nd.visible)return;const p=STATE.progress[nd.key]||'none',show=f==='all'||(f==='drilling'&&p==='drilling')||(f==='learned'&&p==='learned');m.material.opacity=show?0.88:0.08;});
        });
      });
      document.getElementById('g3dSearch').addEventListener('input',function(){
        const q=this.value.toLowerCase();allNodes.forEach(nd=>{const m=meshMap[nd.id];if(!m||!nd.visible)return;m.material.opacity=(!q||nd.label.toLowerCase().includes(q))?0.88:0.08;});
      });

      const clock=new THREE.Clock();
      (function loop(){
        requestAnimationFrame(loop);
        rotX+=(tRX-rotX)*0.08;rotY+=(tRY-rotY)*0.08;zoom+=(tZ-zoom)*0.08;
        pivot.rotation.x=rotX;pivot.rotation.y=rotY;camera.position.z=zoom;
        tRY+=0.0004;
        const rm=meshMap.root;if(rm)rm.material.emissiveIntensity=Math.sin(clock.getElapsedTime()*1.5)*0.2+0.3;
        renderer.render(scene,camera);
      })();
      window.addEventListener('resize',()=>{const r=wrap.getBoundingClientRect();renderer.setSize(r.width,r.height);camera.aspect=r.width/r.height;camera.updateProjectionMatrix();});
    }

    // Sync state when switching to this tab
    window.g3dSyncExpanded();
    window.g3dRefreshColors();
    const r=wrap.getBoundingClientRect();
    renderer.setSize(r.width,r.height);
    camera.aspect=r.width/r.height;
    camera.updateProjectionMatrix();
  };
})();


// â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
loadState();
buildSections();
updateStats();
</script>
</body>
</html>
